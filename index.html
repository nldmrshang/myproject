<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è¡Œä»»åŠ¡ç­¾æ´¾ä¸­å¿ƒ</title>
    
    <script>window.L_DISABLE_3D = true;</script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script src="airport_db.js"></script>
    <script src="airport_coords.js"></script>
    <script src="aircraft_db.js"></script>

    <style>
        :root { 
            --primary: #0f172a; --success: #059669; --warn: #dc2626; --bg: #eef2f7; 
            --card: #ffffff; --border: #cbd5e1; --text: #1e293b; --accent: #2563eb; 
            --crz-color: #f59e0b; /* å·¡èˆªé«˜åº¦å¼ºè°ƒè‰² */
            --card-border-gradient: linear-gradient(90deg, rgba(37,99,235,0.4), rgba(16,185,129,0.4)); /* é»˜è®¤æ¸å˜ï¼Œåç»­ç”¨ JS éšæœºè¦†ç›– */
        }

        [data-theme="dark"] {
            --primary: #f8fafc; --bg: #020617; --card: #1e293b; 
            --border: #334155; --text: #f1f5f9; --accent: #38bdf8;
        }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; 
            display: flex; padding: 20px; gap: 40px; justify-content: center; 
            transition: background 0.3s, color 0.3s;
            text-shadow: 0 1px 2px rgba(15, 23, 42, 0.18);
        }
        
        .editor { 
            width: 340px; background: var(--card); border-radius: 20px; padding: 22px; 
            border: 1px solid var(--border); height: 92vh; overflow-y: auto; 
            position: sticky; top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
        }
        .editor h2 { font-weight: 800; font-size: 20px; color: var(--primary); margin-bottom: 25px; }

        .sb-import-area {
            background: var(--bg); border: 2px dashed var(--accent);
            border-radius: 12px; padding: 15px; margin-bottom: 12px;
        }
        .sb-import-area label { color: var(--accent); margin-top: 0; margin-bottom: 8px; font-weight: 900; }
        .sb-btn { 
            width: 100%; margin-top: 10px; padding: 10px; 
            background: var(--accent); color: #fff; border: none; 
            border-radius: 6px; font-weight: 800; cursor: pointer; transition: 0.2s;
        }
        
        .btn-group { display: flex; flex-direction: row; gap: 8px; justify-content: space-between; flex-wrap: wrap; }
        .btn { 
            flex: 1; border: none; padding: 10px 4px; border-radius: 999px; 
            cursor: pointer; font-weight: 800; color: #fff; transition: 0.2s; font-size: 11px; 
            box-shadow: 0 2px 4px rgba(15,23,42,0.25); white-space: nowrap; min-width: 22%;
        }
        .add-btn { background: var(--accent); } 
        .reset-btn { background: #8b5cf6; }     
        .export-btn { background: #10b981; }  
        .html-btn { background: #f59e0b; }

        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        .leg-block { 
            background: var(--bg); padding: 15px; border-radius: 12px; 
            margin-bottom: 25px; border: 1px solid var(--border); 
            animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .leg-flip-highlight {
            animation: legFlipIn 0.35s cubic-bezier(0.22, 1, 0.36, 1);
            transform-origin: center;
        }
        
        .editor-group {
            background: var(--card); 
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .editor-group-title {
            font-size: 13px;
            font-weight: 900;
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 8px;
        }

        label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; display: block; margin: 0 0 5px; letter-spacing: 1px; }
        
        input, textarea { 
            width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 8px; 
            font-size: 13px; font-family: inherit; box-sizing: border-box; background: var(--bg); outline: none; color: var(--text);
            transition: border 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--accent); }
        input { text-align: center; }
        textarea { text-align: left; resize: vertical; }
        
        .img-manage-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .img-thumb-wrapper { position: relative; width: 60px; height: 60px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
        .img-thumb { width: 100%; height: 100%; object-fit: cover; }
        .del-img-btn { position: absolute; top: 2px; right: 2px; background: var(--warn); color: #fff; border: none; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; font-size: 12px; display:flex; align-items:center; justify-content:center;}
        .mode-toggle { padding: 8px 15px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; font-weight: 800; font-size: 12px; }

        .floating-controls {
            position: fixed;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 20;
            background: var(--card);
            border-radius: 999px;
            box-shadow: 0 18px 40px rgba(15,23,42,0.25);
            border: 1px solid var(--border);
            padding: 8px 6px;
        }
        .floating-btn-group {
            flex-direction: column;
            gap: 6px;
        }

        @keyframes slideUpFade {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes legFlipIn {
            0% { opacity: 0; transform: rotateY(-25deg) translateY(4px); }
            70% { opacity: 1; transform: rotateY(5deg) translateY(0); }
            100% { opacity: 1; transform: rotateY(0deg) translateY(0); }
        }
        @keyframes pulse-icon {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(37, 99, 235, 0); }
            50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(37, 99, 235, 0); }
        }

        .no-animation, .no-animation * {
            animation: none !important;
            transition: none !important;
            opacity: 1 !important; 
        }

        .preview { width: 850px; }
        #capture-area { padding: 40px; background: #fdfcf7; border-radius: 30px; transition: background 0.3s;} 
        
        .card { 
            border-radius: 30px; padding: 55px 45px 45px; 
            box-shadow: 0 30px 60px -12px rgba(0,0,0,0.15); position: relative; 
            margin-bottom: 35px; color: var(--text); overflow: hidden;
            opacity: 0; animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            border: 5px solid transparent;
            background-image: linear-gradient(var(--card), var(--card)), var(--card-border-gradient);
            background-origin: padding-box, border-box;
            background-clip: padding-box, border-box;
        }
        
        .header { 
            display: grid; grid-template-columns: 1fr minmax(0, 1fr) 1fr; 
            align-items: center; 
            margin-bottom: 20px; 
            position: relative;
        }

        .station { display: flex; flex-direction: column; }
        .station.align-left { align-items: flex-start; text-align: left; }
        .station.align-right { align-items: flex-end; text-align: right; }
        .icao { font-size: 74px; font-weight: 900; color: var(--text); letter-spacing: -3px; line-height: 1; margin: 0; }
        .cn-name { font-size: 20px; font-weight: 800; color: var(--accent); margin-top: 12px; }
        
        .route-visual { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; min-width: 0;
        }
        
        .crz-arc-container {
            position: absolute;
            top: 6px;
            left: 0;
            right: 0;
            width: 100%;
            height: 56px;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 0;
        }
        .crz-arc-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            fill: none;
            stroke: #2563eb; /* æ›´æ¥è¿‘åœ°çƒè“çš„æ·±è“è‰² */
            stroke-width: 2;
            stroke-dasharray: 4 4; /* ç‚¹æ›´å¯†é›† */
            opacity: 1;
        }
        .crz-arc-text {
            position: relative;
            background: var(--card);
            padding: 2px 8px;
            border-radius: 12px;
            border: 1.5px solid var(--crz-color);
            color: var(--crz-color);
            font-weight: 900;
            font-size: 14px; /* é«˜åº¦å­—ä½“ç•¥å¤§ */
            z-index: 2;
            box-shadow: 0 3px 10px rgba(245, 158, 11, 0.2);
            transform: translateY(2px); /* æ•´ä½“ç•¥å¾®ä¸‹ç§»ï¼Œè´´è¿‘å¼§çº¿ä¸‹ç¼˜ */
        }

        .plane-line-wrapper { display: flex; align-items: center; width: 100%; margin-bottom: 8px; z-index: 1; }
        .line-segment { flex: 1; min-width: 0; height: 2px; background: rgba(100, 116, 139, 0.5); }
        .plane-box { 
            flex-shrink: 0;
            width: 46px; height: 46px; border: 2.5px solid var(--accent); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            background: var(--card); margin: 0 15px; transition: all 0.3s ease; position: relative; z-index: 1;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.28);
        }
        .plane-box:hover { animation: pulse-icon 1.5s infinite; }
        .plane-box svg { width: 26px; fill: var(--accent); }
        .callsign-text { font-weight: 950; color: #7c3aed; margin-top: 5px; font-size: 20px; letter-spacing: 1.5px; z-index: 1; }

        /* âœ¨ æ ¸å¿ƒè°ƒæ•´ï¼šè·ç¦»åˆ†éš”æ å®Œç¾å¯¹é½ */
        .metrics-divider {
            display: flex;
            align-items: center; /* ç¡®ä¿æ‰€æœ‰å­å…ƒç´ å‚ç›´å±…ä¸­ */
            justify-content: center;
            width: 100%;
            margin-bottom: 25px;
            height: 38px; /* ç•¥å‡é«˜åº¦ï¼Œä½¿æ–‡å­—ä¸è™šçº¿è§†è§‰ä¸­å¿ƒæ›´æ¥è¿‘ */
        }
        .m-line {
            flex: 1;
            height: 0; /* ä»…é€šè¿‡è¾¹æ¡†ç»˜åˆ¶è™šçº¿å³å¯ */
            border-top: 2px dashed rgba(148, 119, 84, 0.85); /* ç±»ä¼¼åœŸåœ°çš„æš–æ£•è‰² */
            opacity: 1;
        }
        .m-data-area {
            display: flex;
            align-items: center; /* åŒºåŸŸå†…æ–‡å­—å‚ç›´å±…ä¸­ */
            gap: 12px;
            padding: 0 25px;
            height: 100%;
        }
        .m-label-sub {
            font-size: 12px; 
            font-weight: 800; 
            color: #94a3b8; 
            letter-spacing: 1px;
            margin: 0;
            line-height: 1;
            padding-top: 0;
        }
        .m-val-sub {
            font-size: 24px; 
            font-weight: 900; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1; 
            margin: 0;
        }
        .val-dist { color: var(--accent); }

        .map-container { 
            width: 100%; height: 480px; background: var(--bg); border-radius: 16px; 
            margin-top: 0; 
            border: 1px solid var(--border); overflow: hidden; z-index: 1; position: relative;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.3);
            opacity: 0; animation: slideUpFade 0.6s 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        [data-theme="dark"] .map-container { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        /* å¯¼å‡ºæ— åœ°å›¾æ¨¡å¼ï¼šä»…éšè—åœ°å›¾ï¼Œä¸å½±å“æ•´ä½“å¸ƒå±€ç»“æ„ */
        .no-map .map-container {
            display: none !important;
        }
        .route-arrow {
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 7px solid #1d4ed8;
            filter: drop-shadow(0 0 1px rgba(255,255,255,0.8));
        }
        .route-arrow-icon { background: none !important; border: none !important; }

        .route-zone { 
            background: var(--bg); border-radius: 16px; padding: 25px; border-left: 8px solid var(--accent); 
            margin: 35px 0; transition: transform 0.3s ease, box-shadow 0.3s ease; 
        }
        .route-zone:hover { transform: translateX(6px); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .proc-grid { display: grid; grid-template-columns: 1.1fr 1fr 1fr 1fr 1fr 1.1fr; gap: 8px; margin-bottom: 25px; }
        .proc-box { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px 4px; text-align: center; }
        .proc-label { font-size: 13px; font-weight: 800; color: var(--text); text-transform: uppercase; margin-bottom: 4px; }
        .proc-val { font-size: 18px; font-weight: 800; color: var(--text); }
        .proc-val.rwy-val { color: #0d9488; }

        .route-title { font-size: 13px; font-weight: 800; color: var(--accent); margin-bottom: 12px; letter-spacing: 1.5px; }
        .route-text { font-family: "Courier New", Courier, monospace; font-size: 20px; font-weight: 800; color: var(--text); line-height: 1.5; word-break: break-all; white-space: pre-wrap; }
        
        .meta-grid { 
            display: flex; justify-content: space-between; align-items: flex-start; 
            border-top: 2px solid var(--border); padding-top: 30px; width: 100%;
        }
        .meta-item { display: flex; flex-direction: column; flex: 1; }
        .meta-item.align-left { align-items: flex-start; text-align: left; }
        .meta-item.align-center { align-items: center; text-align: center; }
        .meta-item.align-right { align-items: center; text-align: right; }
        .m-title { font-size: 12px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1.5px; display: block; margin-bottom: 6px; }
        .station .m-title {
            font-size: 13px;
            color: #0ea5e9;
            text-shadow: 0 1px 2px rgba(15,23,42,0.35);
        }
        .m-title.meta-acft { color: #6366f1; }
        .m-title.meta-altn { color: #b91c1c; }
        .m-title.meta-utc { color: #64748b; }
        .m-val { font-size: 18px; font-weight: 800; color: var(--text); }
        
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 15px; margin-top: 25px; }
        .gallery img { width: 100%; border-radius: 14px; }
        
        .weather-box { margin-top: 10px; padding: 12px; border-radius: 8px; background: var(--card); border: 1px dashed rgba(148, 163, 184, 0.9); }
        .weather-label { font-size: 13px; font-weight: 900; color: var(--accent); margin-bottom: 4px; display: block; text-transform: uppercase;}
        .weather-code { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; font-size: 14px; font-weight: 700; color: var(--text); line-height: 1.6; word-break: break-all;}

        .copy-section {
            margin-top: 25px; padding: 25px; background: var(--card);
            border-radius: 20px; border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            animation: slideUpFade 0.6s 0.3s ease-out forwards; opacity: 0;
        }
        .copy-section h3 { margin-top: 0; font-size: 16px; color: var(--primary); display: flex; align-items: center; justify-content: space-between;}
        .copy-textarea {
            width: 100%; height: 110px; resize: vertical;
            background: var(--bg); color: var(--text); border: 2px dashed var(--border);
            border-radius: 10px; padding: 15px; font-family: "Courier New", Courier, monospace;
            font-weight: bold; margin-bottom: 12px; line-height: 1.5; outline: none; transition: border 0.3s;
        }
        .copy-textarea:focus { border-color: var(--accent); }
        .copy-btn {
            background: var(--accent); color: white; border: none; padding: 10px 20px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 14px;
        }
        .copy-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }

        /* å“åº”å¼å¸ƒå±€ï¼šå¹³æ¿ä¸æ‰‹æœºé€‚é… */
        @media (max-width: 1024px) {
            body {
                flex-direction: column;
                padding: 12px;
                gap: 20px;
            }
            .editor {
                width: 100%;
                position: static;
                height: auto;
            }
            .preview {
                width: 100%;
            }
            #capture-area {
                padding: 24px;
                border-radius: 24px;
            }
            .map-container {
                height: 380px;
            }
            .floating-controls {
                right: 12px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            .editor {
                padding: 16px;
            }
            .icao {
                font-size: 54px;
            }
            .cn-name {
                font-size: 18px;
            }
            .route-text {
                font-size: 16px;
            }
            .map-container {
                height: 300px;
            }
            .floating-controls {
                right: 50%;
                transform: translate(50%, -50%);
            }
        }
    </style>
</head>
<body>

<div id="permanent-vault" style="display:none;"></div>

<datalist id="acft-list"></datalist>

<div class="editor">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
        <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:28px;">âœˆï¸</span>
            <h2>é£è¡Œä»»åŠ¡ç­¾æ´¾</h2>
        </div>
        <button class="mode-toggle" onclick="toggleDarkMode()" id="modeBtn">ğŸŒ™ é»‘å¤œæ¨¡å¼</button>
    </div>

    <div class="sb-import-area">
        <label>âš¡ SimBrief è§£æ</label>
        <textarea id="sb-raw-text" rows="3"></textarea>
        <button class="sb-btn" onclick="parseSimBriefFromClipboard()">ä»å‰ªè´´æ¿è§£æå¹¶è‡ªåŠ¨å¡«å…¥</button>
    </div>

    <div id="editorStack"></div>
</div>

<div class="preview">
    <div id="capture-area">
        <div id="previewZone"></div>
    </div>
    <div id="copy-zone"></div>
</div>

<!-- å³ä¸‹è§’æ‚¬æµ®æ“ä½œæ¡ï¼šå§‹ç»ˆå±•ç¤ºå››ä¸ªæŒ‰é’®çš„ç«–æ¡ -->
<div class="floating-controls">
    <div class="btn-group floating-btn-group">
        <button class="btn add-btn" onclick="addNewLeg()">å¢åŠ èˆªæ®µ</button>
        <button class="btn reset-btn" onclick="resetAllMaps()">å±…ä¸­èˆªçº¿</button>
        <button class="btn reset-btn" id="mapExportToggleBtn_floating" onclick="toggleExportMapMode()">å«åœ°å›¾å¯¼å‡º</button>
        <button class="btn export-btn" onclick="exportAsImage()">ä¿å­˜å›¾ç‰‡</button>
        <button class="btn html-btn" onclick="exportAsHTML()">ç”Ÿæˆç½‘é¡µ</button>
    </div>
</div>

<script>
let airportGeoData = {};
let mapInstances = {}; 
let mapDoms = {}; 
let routeLayers = {}; 
let altLayers = {};
let lastLegICAO = {}; 
let exportWithoutMap = false; // æ˜¯å¦åœ¨å¯¼å‡ºæ—¶éšè—åœ°å›¾ï¼Œä»…ä¿ç•™è®¡åˆ’ä¸èˆªè·¯

function syncMapExportToggleLabels() {
    const mainBtn = document.getElementById('mapExportToggleBtn');
    const floatBtn = document.getElementById('mapExportToggleBtn_floating');
    const text = exportWithoutMap ? 'ä»…è®¡åˆ’+èˆªè·¯' : 'å«åœ°å›¾å¯¼å‡º';
    if (mainBtn) mainBtn.innerText = text;
    if (floatBtn) floatBtn.innerText = text;
}

function initAircraftList() {
    const list = document.getElementById('acft-list');
    if (!list || typeof window.AIRCRAFT_DB === 'undefined') return;
    list.innerHTML = '';
    (window.AIRCRAFT_DB || []).forEach(code => {
        const opt = document.createElement('option');
        opt.value = code;
        list.appendChild(opt);
    });
}

let flightData = [{ call: '', acft: '', dist: '', crz: '', dep: '', depN: '', depRwy: '', sid: '', depTrans: '', arr: '', arrN: '', arrTrans: '', star: '', arrRwy: '', alt: '', altN: '', rte: '', imgs: [], depWx: '', arrWx: '' }];

fetch('https://cdn.jsdelivr.net/gh/mwgg/Airports@master/airports.json')
    .then(res => res.json())
    .then(data => {
        airportGeoData = data;
        for (let icao in data) { 
            if (typeof DB !== 'undefined' && !DB[icao] && icao.length === 4) { 
                DB[icao] = data[icao].city || data[icao].name; 
            } 
        }
        draw();
    });

function applyRandomCardBorderGradient() {
    const gradients = [
        'linear-gradient(90deg, rgba(37,99,235,0.45), rgba(16,185,129,0.45))',
        'linear-gradient(90deg, rgba(245,158,11,0.5), rgba(239,68,68,0.45))',
        'linear-gradient(90deg, rgba(56,189,248,0.5), rgba(129,140,248,0.5))',
        'linear-gradient(90deg, rgba(236,72,153,0.5), rgba(34,211,238,0.45))',
        'linear-gradient(90deg, rgba(22,163,74,0.5), rgba(190,242,100,0.45))',
        'linear-gradient(90deg, rgba(148,163,184,0.6), rgba(30,64,175,0.6))'
    ];
    const pick = gradients[Math.floor(Math.random() * gradients.length)];
    document.documentElement.style.setProperty('--card-border-gradient', pick);
}

window.onload = () => { 
    applyRandomCardBorderGradient();
    initAircraftList();
    renderEditor(); 
    draw(); 
};

async function parseSimBriefFromClipboard() {
    const ta = document.getElementById('sb-raw-text');
    if (!navigator.clipboard || !navigator.clipboard.readText) {
        alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥è¯»å–å‰ªè´´æ¿ï¼Œè¯·å…ˆæ‰‹åŠ¨ç²˜è´´ SimBrief æ–‡æœ¬ã€‚");
        ta.focus();
        return;
    }
    try {
        const clip = await navigator.clipboard.readText();
        if (!clip || !clip.trim()) {
            alert("å‰ªè´´æ¿é‡Œæ²¡æœ‰æœ‰æ•ˆæ–‡æœ¬ï¼Œè¯·å…ˆå¤åˆ¶ SimBrief OFP å†ç‚¹å‡»æŒ‰é’®ã€‚");
            ta.focus();
            return;
        }
        ta.value = clip;
        parseSimBrief(clip);
    } catch (e) {
        alert("æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·å…ˆæ‰‹åŠ¨ç²˜è´´ SimBrief æ–‡æœ¬ã€‚");
        ta.focus();
    }
}

function parseSimBrief(sourceText) {
    const raw = sourceText || document.getElementById('sb-raw-text').value;
    if (!raw) return alert("è¯·å…ˆç²˜è´´ SimBrief æ–‡æœ¬å†…å®¹ï¼");
    let idx = flightData.length - 1;
    
    const callMatch = raw.match(/ATC\s+C\/S\s+([A-Z0-9]+)/i) || raw.match(/CALLSIGN[:\s]+([A-Z0-9]+)/i) || raw.match(/OFP\s+FOR\s+([A-Z0-9]+)/i);
    if (callMatch) flightData[idx].call = callMatch[1].trim();
    
    const acftMatch = raw.match(/(?:AIRCRAFT|ACFT)[:\s]+([A-Z0-9\-]+)/i) || raw.match(/\s(A\d{3}|B\d{3}|B77[0-9]|B78[0-9]|C\d{3}|MD\d{2}|E\d{3})\s/i) || raw.match(/(?:FENIX\s+)(A\d{3})/i);
    if (acftMatch) flightData[idx].acft = acftMatch[1].trim();
    
    let depArrMatch = raw.match(/([A-Z]{4})\s*\/\s*[A-Z]{3}\s+([A-Z]{4})\s*\/\s*[A-Z]{3}/);
    if (!depArrMatch) depArrMatch = raw.match(/FROM\s+([A-Z]{4})\s+TO\s+([A-Z]{4})/i) || raw.match(/ORIGIN[:\s]+([A-Z]{4})[\s\S]+?DEST(?:INATION)?[:\s]+([A-Z]{4})/i);
    if (depArrMatch) { 
        flightData[idx].dep = depArrMatch[1]; 
        flightData[idx].depN = (typeof DB !== 'undefined' && DB[depArrMatch[1]]) || ""; 
        flightData[idx].arr = depArrMatch[2]; 
        flightData[idx].arrN = (typeof DB !== 'undefined' && DB[depArrMatch[2]]) || ""; 
    }
    
    const altMatch = raw.match(/ALTN(?:ATE)?\s*[:\s]+\s*([A-Z]{4})/i) || raw.match(/ALTN\s+([A-Z]{4})/i) || raw.match(/ALTERNATE[:\s]+([A-Z]{4})/i);
    if (altMatch) { flightData[idx].alt = altMatch[1]; flightData[idx].altN = (typeof DB !== 'undefined' && DB[altMatch[1]]) || ""; }
    
    const distMatch = raw.match(/(?:GND|TRIP|GC|AIR)\s+DIST(?:ANCE)?:?\s*(\d+)/i) || raw.match(/DIST(?:ANCE)?:\s*(\d+)/i) || raw.match(/(\d+)\s*NM\s+(?:total|distance)/i);
    if (distMatch) flightData[idx].dist = distMatch[1];

    // âœ¨ æ·±åº¦ä¼˜åŒ–ï¼šæ™ºèƒ½è¯†åˆ«å…¬åˆ¶é«˜åº¦å¹¶è½¬æ¢ä¸º3ä½è‹±å°º FL
    const flStepsMatch = raw.match(/FL\s+STEPS\s+([A-Z0-9\/]+)/i);
    let maxFL = 0;

    if (flStepsMatch) {
        const stepsParts = flStepsMatch[1].split('/');
        stepsParts.forEach(part => {
            if (/^\d{3,5}$/.test(part)) {
                let val = parseInt(part, 10);
                // å¦‚æœæ˜¯ 4 ä½æ•°å­—ï¼ˆå¦‚ 0840ã€1020ï¼‰ï¼ŒSimBrief é€šå¸¸è¡¨ç¤ºâ€œç™¾ç±³é«˜åº¦ç­‰çº§â€ï¼ˆ0840 => 8400mï¼‰
                if (part.length === 4 && val > 600 && val < 1400) { 
                        const meters = val * 10;          // 0840 -> 8400m
                        const feet = meters * 3.28084;    // è½¬è‹±å°º
                        val = Math.round(feet / 100);     // è‹±å°ºè½¬ FLï¼ˆç™¾è‹±å°ºï¼‰
                } else if (part.length === 5) {
                        val = Math.round(val / 100);      // 5ä½è‹±å°ºé«˜åº¦ï¼ˆå¦‚ 35000ï¼‰è½¬ FL
                }
                if (val > maxFL) maxFL = val;
            }
        });
    } else {
        // æ•è·å¯é€‰çš„ Mï¼ˆç±³ï¼‰å•ä½ï¼Œå¦‚æœæ˜¯ç±³ï¼Œåˆ™å…ˆè½¬è‹±å°ºå†è½¬ FL
        const crzMatch = raw.match(/(?:INITIAL\s+CRZ|CRZ\s+SYS|CRZ\s+ALT|CRZ|LVL):?\s*(?:FL)?(\d{2,5})(M?)/i);
        if (crzMatch) {
            let val = parseInt(crzMatch[1], 10);
            const isMeters = crzMatch[2] && crzMatch[2].toUpperCase() === 'M';

            if (isMeters) {
                // ä¾‹å¦‚ 10630M -> çº¦ 34868ft -> FL349
                const meters = val;
                const feet = meters * 3.28084;
                val = Math.round(feet / 100); // è½¬æˆä»¥ç™¾è‹±å°ºä¸ºå•ä½çš„ FL
            } else if (crzMatch[1].length === 5) {
                // 5 ä½çº¯æ•°å­—ï¼Œè§†ä¸ºè‹±å°ºé«˜åº¦ï¼ˆå¦‚ 35000ï¼‰ï¼Œè½¬ä¸º FL
                val = Math.round(val / 100);
            }
            maxFL = val;
        }
    }
    if (maxFL > 0) {
        // ç»Ÿä¸€å¤„ç†ä¸º 3 ä½ FLï¼ˆæœ€å¤š 999ï¼‰ï¼Œå¤šä½™ä½æ•°æˆªæ–­
        let flVal = Math.min(maxFL, 999);
        let flStr = flVal.toString();
        if (flStr.length > 3) flStr = flStr.slice(0, 3);
        flightData[idx].crz = flStr;
    }

    const routeBlock = raw.match(/ROUTE ID:[\s\S]+?\n([\s\S]+?)(?:\n\n|\n-)/i) || raw.match(/ROUTING:[\s\S]+?\n([\s\S]+?)(?:\n\n|$)/i) || raw.match(/FULL ROUTE:?\s*\n([\s\S]+?)(?:\n\n|$)/i);
    if (routeBlock) {
        let fullRte = routeBlock[1].replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
        let parts = fullRte.split(/\s+/).filter(Boolean);
        if (parts[0] && parts[0].includes('/')) flightData[idx].depRwy = parts[0].split('/')[1];
        if (parts.length > 1) flightData[idx].sid = parts[1];
        let lastPart = parts[parts.length - 1];
        if (lastPart && lastPart.includes('/')) flightData[idx].arrRwy = lastPart.split('/')[1];
        if (parts.length > 3) { let starCandidate = parts[parts.length - 2] === 'DCT' ? parts[parts.length - 3] : parts[parts.length - 2]; flightData[idx].star = starCandidate; }
        flightData[idx].rte = parts.slice(1, parts.length - 1).join(' ');
    }
    
    const depWxMatch = raw.match(/Departure:[\s\S]+?SA\s+([\d]{6}\s+[\s\S]+?)(?=\n)/i) || raw.match(/DEPARTURE[\s\S]+?METAR[:\s]*([A-Z0-9\s]+(?=\n|$))/i);
    if (depWxMatch) flightData[idx].depWx = depWxMatch[1].trim();
    
    const arrWxMatch = raw.match(/Destination:[\s\S]+?SA\s+([\d]{6}\s+[\s\S]+?)(?=\n)/i) || raw.match(/DEST(?:INATION)?[\s\S]+?METAR[:\s]*([A-Z0-9\s]+(?=\n|$))/i);
    if (arrWxMatch) flightData[idx].arrWx = arrWxMatch[1].trim();
    
    renderEditor(); draw(); 
}

function toggleDarkMode() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
    document.getElementById('modeBtn').innerText = isDark ? 'ğŸŒ™ é»‘å¤œæ¨¡å¼' : 'â˜€ï¸ ç™½å¤©æ¨¡å¼';
    Object.values(mapInstances).forEach(m => m.invalidateSize());
}

function resetAllMaps() {
    Object.keys(mapInstances).forEach(idx => {
        const map = mapInstances[idx];
        const layer = routeLayers[idx];
        const altLayer = altLayers[idx];
        if (map && layer) {
            map.invalidateSize();
            let bounds = layer.getBounds();
            if (altLayer) bounds = bounds.extend(altLayer.getBounds());
            map.fitBounds(bounds, { padding: [100, 100], animate: true });
        }
    });
}

function toggleExportMapMode() {
    exportWithoutMap = !exportWithoutMap;
    syncMapExportToggleLabels();
}

function toggleFloatingPanel(event) {
    const container = document.querySelector('.floating-controls');
    if (!container) return;
    // é¿å…å†…éƒ¨æŒ‰é’®ç‚¹å‡»å†æ¬¡è§¦å‘å±•å¼€/æŠ˜å é€»è¾‘
    if (event && event.target && event.target.tagName === 'BUTTON') return;
    const isCollapsed = container.classList.contains('fc-collapsed');
    if (isCollapsed) {
        container.classList.remove('fc-collapsed');
        container.classList.add('fc-expanded');
    } else {
        container.classList.remove('fc-expanded');
        container.classList.add('fc-collapsed');
    }
}

function updateCopyText(idx) {
    let leg = flightData[idx];
    let routeParts = [];
    if(leg.dep) routeParts.push(leg.dep + (leg.depRwy ? '/' + leg.depRwy : ''));
    if(leg.sid) routeParts.push(leg.sid);
    if(leg.rte) routeParts.push(leg.rte);
    if(leg.star) routeParts.push(leg.star);
    if(leg.arr) routeParts.push(leg.arr + (leg.arrRwy ? '/' + leg.arrRwy : ''));
    
    let copyTextContent = routeParts.join(' ').trim();
    let copyArea = document.getElementById(`copy-text-area-${idx}`);
    if (copyArea) copyArea.value = copyTextContent;
}

async function fetchMetar(idx, type) {
    const icao = type === 'dep' ? flightData[idx].dep : flightData[idx].arr;
    if (!icao || icao.length < 4) return alert("è¯·è¾“å…¥æœºåœº ICAO");
    const btn = event.target; btn.innerText = "...";
    try {
        const response = await fetch(`https://metar.vatsim.net/metar.php?id=${icao.toUpperCase()}`);
        const data = await response.text();
        if (data && data.length > 5) { 
            flightData[idx][type + 'Wx'] = data.trim(); 
            let container = document.getElementById(`disp-${type}Wx-container-${idx}`);
            if(container) container.innerHTML = `<div class="weather-box"><span class="weather-label">${type === 'dep'?'DEPARTURE':'ARRIVAL'} METAR (${icao})</span><div class="weather-code">${data.trim()}</div></div>`;
            updateCopyText(idx);
        }
    } catch (e) { alert("ç½‘ç»œé”™è¯¯"); } finally { btn.innerText = type === 'dep' ? "èµ·é£å¤©æ°”" : "åˆ°è¾¾å¤©æ°”"; }
}

function deleteWx(idx, type) { 
    flightData[idx][type + 'Wx'] = ''; 
    let container = document.getElementById(`disp-${type}Wx-container-${idx}`);
    if(container) container.innerHTML = '';
    updateCopyText(idx);
}

function exportAsImage() {
    const target = document.getElementById('capture-area');
    const btn = document.querySelector('.export-btn');
    const originalBtnText = btn.innerText;
    btn.innerText = "å‡†å¤‡èˆªå›¾åŠ è½½..."; btn.disabled = true;
    
    window.scrollTo(0, 0);

    target.classList.add('no-animation');
    if (exportWithoutMap) target.classList.add('no-map');
    target.offsetHeight; 

    Object.keys(mapInstances).forEach(idx => {
        const map = mapInstances[idx];
        const layer = routeLayers[idx];
        const altLayer = altLayers[idx];
        if (map && layer) {
            map.invalidateSize();
            let b = layer.getBounds();
            if (altLayer) b = b.extend(altLayer.getBounds());
            map.fitBounds(b, { padding: [80, 80], animate: false });
        }
    });

    setTimeout(() => {
        btn.innerText = "ç”Ÿæˆé«˜æ¸…å›¾ç‰‡ä¸­...";
        html2canvas(target, { 
            useCORS: true, 
            allowTaint: false, 
            scale: 3, 
            backgroundColor: null,
            logging: false
        }).then(canvas => {
            const link = document.createElement('a'); 
            link.download = `Dispatch_${flightData[0].call || 'Plan'}.png`;
            link.href = canvas.toDataURL("image/png"); 
            link.click();
        }).catch(err => {
            console.error(err);
            alert("æˆªå›¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
        }).finally(() => {
            target.classList.remove('no-animation');
            target.classList.remove('no-map');
            btn.innerText = originalBtnText; btn.disabled = false;
        });
    }, 1500); 
}

function exportAsHTML() {
    const target = document.getElementById('capture-area');
    const btn = document.querySelector('.html-btn');
    const originalBtnText = btn.innerText;
    btn.innerText = "å‡†å¤‡èˆªå›¾åŠ è½½..."; btn.disabled = true;
    
    window.scrollTo(0, 0);

    target.classList.add('no-animation');
    if (exportWithoutMap) target.classList.add('no-map');
    target.offsetHeight; 

    Object.keys(mapInstances).forEach(idx => {
        const map = mapInstances[idx];
        const layer = routeLayers[idx];
        const altLayer = altLayers[idx];
        if (map && layer) {
            map.invalidateSize();
            let b = layer.getBounds();
            if (altLayer) b = b.extend(altLayer.getBounds());
            map.fitBounds(b, { padding: [80, 80], animate: false });
        }
    });

    setTimeout(() => {
        btn.innerText = "æ­£åœ¨æ‰“åŒ…ç½‘é¡µ...";
        html2canvas(target, { 
            useCORS: true, 
            allowTaint: false, 
            scale: 3, 
            backgroundColor: null,
            logging: false
        }).then(canvas => {
            const imgData = canvas.toDataURL("image/png");

            let cleanRouteText = "";
            flightData.forEach((leg, i) => {
                if (flightData.length > 1) cleanRouteText += `--- èˆªæ®µ ${i + 1} ---\n`;
                let routeParts = [];
                if(leg.dep) routeParts.push(leg.dep + (leg.depRwy ? '/' + leg.depRwy : ''));
                if(leg.sid) routeParts.push(leg.sid);
                if(leg.rte) routeParts.push(leg.rte);
                if(leg.star) routeParts.push(leg.star);
                if(leg.arr) routeParts.push(leg.arr + (leg.arrRwy ? '/' + leg.arrRwy : ''));
                let routeStr = routeParts.join(' ').trim();
                if (routeStr) {
                    cleanRouteText += routeStr + "\n\n";
                }
            });
            cleanRouteText = cleanRouteText.trim();

            const htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è¡Œç®€æŠ¥ - ${flightData[0].call || 'Plan'}</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; 
            background: #f1f5f9; color: #1e293b; margin: 0; padding: 40px 20px; 
            display: flex; flex-direction: column; align-items: center; 
        }
        .container { 
            max-width: 900px; width: 100%; display: flex; flex-direction: column; gap: 30px; 
        }
        .image-box { 
            background: #cbd5e1; border-radius: 30px; padding: 40px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; 
        }
        .image-box img { 
            max-width: 100%; height: auto; display: block; margin: 0 auto; 
            border-radius: 10px; 
        }
        .text-box { 
            background: #ffffff; border-radius: 20px; padding: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid #cbd5e1;
        }
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; 
        }
        .header h3 { 
            margin: 0; color: #0f172a; font-size: 18px; display: flex; align-items: center; gap: 8px;
        }
        .copy-btn { 
            background: #2563eb; color: #fff; border: none; padding: 10px 20px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; 
        }
        .copy-btn:hover { background: #1d4ed8; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(37,99,235,0.3); }
        textarea { 
            width: 100%; height: 160px; resize: vertical; padding: 15px; box-sizing: border-box; 
            border: 2px dashed #cbd5e1; border-radius: 12px; background: #f8fafc; 
            font-family: "Courier New", Courier, monospace; font-size: 16px; font-weight: bold;
            color: #334155; outline: none; line-height: 1.5; transition: border 0.3s;
        }
        textarea:focus { border-color: #2563eb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="image-box">
            <img src="${imgData}" alt="Flight Dispatch Board">
        </div>
        
        <div class="text-box">
            <div class="header">
                <h3>ENROUTE BRIEFING</h3>
                <button class="copy-btn" onclick="copyRouteText(this)">ä¸€é”®å¤åˆ¶</button>
            </div>
            <textarea id="route-text" readonly>${cleanRouteText}</textarea>
        </div>
    </div>

    <script>
        function copyRouteText(btn) {
            const ta = document.getElementById('route-text');
            ta.select();
            ta.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(ta.value).then(() => {
                const originalText = btn.innerText;
                btn.innerText = "âœ… å¤åˆ¶æˆåŠŸ";
                btn.style.background = "#059669";
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.background = "";
                }, 2000);
            });
        }
    <\/script>
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `FlightBriefing_${flightData[0].call || 'Plan'}.html`;
            link.click();

        }).catch(err => {
            console.error(err);
            alert("ç½‘é¡µæ‰“åŒ…å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
        }).finally(() => {
            target.classList.remove('no-animation');
            target.classList.remove('no-map');
            btn.innerText = originalBtnText; btn.disabled = false;
        });
    }, 1500); 
}

function copyTextData(idx, btnEl) {
    const copyTarget = document.getElementById(`copy-text-area-${idx}`);
    copyTarget.select();
    copyTarget.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyTarget.value).then(() => {
        const originalText = btnEl.innerText;
        btnEl.innerText = "âœ… å¤åˆ¶æˆåŠŸ";
        btnEl.style.background = "var(--success)";
        setTimeout(() => {
            btnEl.innerText = originalText;
            btnEl.style.background = ""; 
        }, 2000);
    });
}

function updateDistCrz(idx, field, val) {
    // å·¡èˆªé«˜åº¦ä¸èˆªç¨‹åšè¾“å…¥è§„èŒƒåŒ–ï¼Œä¿è¯ä½æ•°ä¸æ ¼å¼
    if (field === 'crz') {
        // åªä¿ç•™æ•°å­—ï¼Œé™åˆ¶ä¸ºæœ€å¤š 3 ä½
        let digits = (val || '').toString().replace(/\D/g, '');
        if (digits.length > 3) digits = digits.slice(0, 3);
        flightData[idx][field] = digits;
    } else if (field === 'dist') {
        // è·ç¦»åªä¿ç•™æ•°å­—
        let digits = (val || '').toString().replace(/[^\d]/g, '');
        flightData[idx][field] = digits;
    } else {
        flightData[idx][field] = val;
    }
    let leg = flightData[idx];
    let rowEl = document.getElementById(`disp-metrics-divider-${idx}`);
    let arcEl = document.getElementById(`disp-crz-arc-${idx}`);
    let distSpan = document.getElementById(`disp-dist-val-${idx}`);
    let crzText = document.getElementById(`disp-crz-text-${idx}`);
    
    // âœ¨ æ ¸å¿ƒè°ƒæ•´ï¼šç¡®ä¿æ˜¾ç¤ºä¸º 3 ä½æ•°å­—çš„ FL æ ¼å¼
    let cleanCrz = leg.crz ? leg.crz.toString().replace(/^FL\s*/i, '').trim() : '';
    if (cleanCrz.length > 3) cleanCrz = cleanCrz.substring(0, 3);
    
    // æ›´æ–°è·ç¦»æ˜¾ç¤º
    if (leg.dist) {
        if (rowEl) rowEl.style.display = 'flex';
        if (distSpan) distSpan.innerText = leg.dist + ' NM';
    } else {
        if (rowEl) rowEl.style.display = 'none';
    }

    // æ›´æ–°å·¡èˆªé«˜åº¦å¼§çº¿æ˜¾ç¤ºï¼ˆæ— ç©ºæ ¼ï¼Œå¦‚ FL361ï¼‰
    if (cleanCrz) {
        if (arcEl) arcEl.style.display = 'flex';
        if (crzText) crzText.innerText = 'FL' + cleanCrz;
    } else {
        if (arcEl) arcEl.style.display = 'none';
    }
}

function autoInput(idx, field, el) {
    const code = el.value.toUpperCase(); 
    flightData[idx][field] = code;
    
    let dispEl = document.getElementById(`disp-${field}-${idx}`);
    if(dispEl) dispEl.innerText = code;

    const nameField = field + 'N';
    const airportName = (typeof DB !== 'undefined' && DB[code]) ? DB[code] : '';
    flightData[idx][nameField] = airportName;

    const targetInput = document.getElementById(`${nameField}-${idx}`);
    if (targetInput) targetInput.value = airportName;

    let dispNameEl = document.getElementById(`disp-${nameField}-${idx}`);
    if(dispNameEl) dispNameEl.innerText = airportName;

    updateCopyText(idx);

    if ((field === 'dep' || field === 'arr') && flightData[idx].dep.length === 4 && flightData[idx].arr.length === 4) {
        initMapForLeg(idx);
    }
}

function updateData(idx, field, val) { 
    flightData[idx][field] = val; 
    let dispEl = document.getElementById(`disp-${field}-${idx}`);
    if(dispEl) dispEl.innerText = val;
    updateCopyText(idx);
}

function addNewLeg() {
    const lastLeg = flightData[flightData.length - 1];
    flightData.push({ call: lastLeg.call, acft: lastLeg.acft, dist: '', crz: '', dep: lastLeg.arr, depN: lastLeg.arrN, depRwy: '', sid: '', depTrans: '', arr: '', arrN: '', arrTrans: '', star: '', arrRwy: '', alt: '', altN: '', rte: '', imgs: [], depWx: '', arrWx: '' });
    renderEditor(); 
    draw();
}

function deleteLeg(idx) {
    if (flightData.length > 1) { flightData.splice(idx, 1); renderEditor(); draw(); }
}

function handleFiles(e, idx) {
    Array.from(e.target.files).forEach(f => {
        let r = new FileReader(); r.onload = (ev) => { flightData[idx].imgs.push(ev.target.result); renderEditor(); draw(); }; r.readAsDataURL(f);
    });
}

function deleteImg(legIdx, imgIdx) { flightData[legIdx].imgs.splice(imgIdx, 1); renderEditor(); draw(); }

function renderEditor() {
    const stack = document.getElementById('editorStack'); 
    stack.innerHTML = '';
    
    flightData.forEach((leg, i) => {
        const div = document.createElement('div'); 
        div.className = 'leg-block';
        div.id = `editor-leg-${i}`;
        
        let imgsHtml = (leg.imgs || []).map((img, imgIdx) => `
            <div class="img-thumb-wrapper">
                <img src="${img}" class="img-thumb">
                <button class="del-img-btn" onclick="deleteImg(${i}, ${imgIdx})">Ã—</button>
            </div>
        `).join('');
        
        let deleteBtnHtml = flightData.length > 1 ? `
            <button onclick="deleteLeg(${i})" style="background:none; border:none; color:var(--warn); cursor:pointer; font-weight:800; font-size:12px; padding:0;">[åˆ é™¤è¯¥æ®µ]</button>
        ` : '';
        
        let wxButtonsHtml = `
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div style="display:flex; gap:5px;">
                    <button onclick="fetchMetar(${i}, 'dep')" style="flex:1; background:var(--accent); color:#fff; border:none; border-radius:6px; font-size:11px; padding:8px; cursor:pointer;">èµ·é£å¤©æ°”</button>
                    <button onclick="deleteWx(${i}, 'dep')" style="background:var(--warn); color:#fff; border:none; border-radius:6px; font-size:11px; width:35px; cursor:pointer;">æ’¤</button>
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="fetchMetar(${i}, 'arr')" style="flex:1; background:var(--accent); color:#fff; border:none; border-radius:6px; font-size:11px; padding:8px; cursor:pointer;">åˆ°è¾¾å¤©æ°”</button>
                    <button onclick="deleteWx(${i}, 'arr')" style="background:var(--warn); color:#fff; border:none; border-radius:6px; font-size:11px; width:35px; cursor:pointer;">æ’¤</button>
                </div>
            </div>
        `;
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span style="font-size:14px; font-weight:900; color:var(--text);">âœˆï¸ èˆªæ®µ ${i + 1}</span>
                ${deleteBtnHtml}
            </div>
            
            <div class="editor-group">
                <div class="editor-group-title">åŸºç¡€ä¿¡æ¯</div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1.2;">
                        <label>èˆªç­å·</label>
                        <input type="text" value="${leg.call}" oninput="updateData(${i}, 'call', this.value)">
                    </div>
                    <div style="flex:1.5;">
                        <label>æœºå‹</label>
                        <input type="text" list="acft-list" value="${leg.acft}" oninput="updateData(${i}, 'acft', this.value)">
                    </div>
                </div>
            </div>
            
            <div class="editor-group">
                <div class="editor-group-title">èˆªç«™ä¸èˆªç¨‹</div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>èµ·é£ ICAO</label>
                        <input type="text" value="${leg.dep}" maxlength="4" oninput="autoInput(${i}, 'dep', this)">
                    </div>
                    <div style="flex:1;">
                        <label>åˆ°è¾¾ ICAO</label>
                        <input type="text" value="${leg.arr}" maxlength="4" oninput="autoInput(${i}, 'arr', this)">
                    </div>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:8px;">
                    <input type="text" id="depN-${i}" value="${leg.depN}" oninput="updateData(${i}, 'depN', this.value)">
                    <input type="text" id="arrN-${i}" value="${leg.arrN}" oninput="updateData(${i}, 'arrN', this.value)">
                </div>
                
                <div style="display:flex; gap:10px; margin-top:8px;">
                    <div style="flex:1;">
                        <label>èˆªç¨‹ (NM)</label>
                        <input type="text" value="${leg.dist || ''}" oninput="updateDistCrz(${i}, 'dist', this.value)">
                    </div>
                    <div style="flex:1;">
                        <label>å·¡èˆªé«˜åº¦ (FL)</label>
                        <input type="text" value="${leg.crz || ''}" oninput="updateDistCrz(${i}, 'crz', this.value)">
                    </div>
                </div>
            </div>
            
            <div class="editor-group">
                <div class="editor-group-title">èˆªè·¯ä¸ç¨‹åº</div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>ç¦»åœºè·‘é“</label>
                        <input type="text" value="${leg.depRwy}" oninput="updateData(${i}, 'depRwy', this.value)">
                    </div>
                    <div style="flex:1.5;">
                        <label>ç¦»åœºç¨‹åº</label>
                        <input type="text" value="${leg.sid}" oninput="updateData(${i}, 'sid', this.value)">
                    </div>
                    <div style="flex:1;">
                        <label>ç¦»åœºè¿‡æ¸¡</label>
                        <input type="text" value="${leg.depTrans}" oninput="updateData(${i}, 'depTrans', this.value)">
                    </div>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:8px;">
                    <div style="flex:1;">
                        <label>è¿›åœºè·‘é“</label>
                        <input type="text" value="${leg.arrRwy}" oninput="updateData(${i}, 'arrRwy', this.value)">
                    </div>
                    <div style="flex:1.5;">
                        <label>è¿›åœºç¨‹åº</label>
                        <input type="text" value="${leg.star}" oninput="updateData(${i}, 'star', this.value)">
                    </div>
                    <div style="flex:1;">
                        <label>è¿›åœºè¿‡æ¸¡</label>
                        <input type="text" value="${leg.arrTrans}" oninput="updateData(${i}, 'arrTrans', this.value)">
                    </div>
                </div>
                
                <label style="margin-top:12px;">å¤‡é™åœº (ALTN)</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" value="${leg.alt}" maxlength="4" oninput="autoInput(${i}, 'alt', this)" style="flex:1;">
                    <input type="text" id="altN-${i}" value="${leg.altN}" oninput="updateData(${i}, 'altN', this.value)" style="flex:2;">
                </div>
                
                <label style="margin-top:12px;">èˆªè·¯ä¿¡æ¯ (ROUTE)</label>
                <textarea rows="3" oninput="updateData(${i}, 'rte', this.value)">${leg.rte}</textarea>
            </div>
            
            <div class="editor-group">
                <div class="editor-group-title">æ°”è±¡ä¸é™„ä»¶</div>
                ${wxButtonsHtml}
                
                <label style="margin-top:15px;">æ·»åŠ å‚è€ƒå›¾</label>
                <input type="file" multiple accept="image/*" onchange="handleFiles(event, ${i})">
                <div class="img-manage-list">${imgsHtml}</div>
            </div>
        `;
        stack.appendChild(div);
    });
}

function initMapForLeg(idx) {
    const depICAO = flightData[idx].dep; const arrICAO = flightData[idx].arr;
    const container = document.getElementById(`map-placeholder-${idx}`);
    if (!container) return;
    let depP, arrP, altP;
    if (typeof COORDS_DB !== 'undefined' && COORDS_DB[depICAO]) { depP = { lat: COORDS_DB[depICAO][0], lon: COORDS_DB[depICAO][1] }; } else if (airportGeoData[depICAO]) { depP = { lat: airportGeoData[depICAO].lat, lon: airportGeoData[depICAO].lon }; }
    if (typeof COORDS_DB !== 'undefined' && COORDS_DB[arrICAO]) { arrP = { lat: COORDS_DB[arrICAO][0], lon: COORDS_DB[arrICAO][1] }; } else if (airportGeoData[arrICAO]) { arrP = { lat: airportGeoData[arrICAO].lat, lon: airportGeoData[arrICAO].lon }; }
    const altICAO = flightData[idx].alt;
    if (altICAO) {
        if (typeof COORDS_DB !== 'undefined' && COORDS_DB[altICAO]) { altP = { lat: COORDS_DB[altICAO][0], lon: COORDS_DB[altICAO][1] }; } 
        else if (airportGeoData[altICAO]) { altP = { lat: airportGeoData[altICAO].lat, lon: airportGeoData[altICAO].lon }; }
    }
    
    if (!depP || !arrP) { container.innerHTML = ""; return; }
    
    const currentKey = `${depICAO}-${arrICAO}-${altICAO || ''}`;
    if (lastLegICAO[idx] === currentKey && mapDoms[idx]) { 
        container.appendChild(mapDoms[idx]); 
        if (mapInstances[idx]) {
             mapInstances[idx].invalidateSize();
             const rl = routeLayers[idx];
             if (rl) {
                 let b = rl.getBounds();
                 if (altLayers[idx]) b = b.extend(altLayers[idx].getBounds());
                 mapInstances[idx].fitBounds(b, { padding: [80, 80], animate: false });
             }
        }
        return; 
    }
    
    if (mapInstances[idx]) mapInstances[idx].remove();
    container.innerHTML = ''; 
    
    const mapDiv = document.createElement('div'); mapDiv.className = 'map-container';
    container.appendChild(mapDiv); mapDoms[idx] = mapDiv;
    
    const map = L.map(mapDiv, { zoomControl: false, attributionControl: false, fadeAnimation: false, zoomAnimation: false, preferCanvas: true });
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', crossOrigin: true }).addTo(map);

    const pts = [[depP.lat, depP.lon], [arrP.lat, arrP.lon]];
    // èµ·é£æœºåœºç‚¹ï¼šæ´‹çº¢è‰²
    L.circleMarker(pts[0], { radius: 5, color: '#db2777', fillColor: '#db2777', fillOpacity: 1 }).addTo(map);
    // åˆ°è¾¾æœºåœºç‚¹ï¼šä¸ STAR ç›¸åŒçš„ç»¿è‰²
    L.circleMarker(pts[1], { radius: 5, color: '#059669', fillColor: '#059669', fillOpacity: 1 }).addTo(map);
    
    const offsetX = pts[1][1] - pts[0][1]; const offsetY = pts[1][0] - pts[0][0];
    const r = Math.sqrt(Math.pow(offsetX, 2) + Math.pow(offsetY, 2)); const theta = Math.atan2(offsetY, offsetX);
    const controlPoint = [ pts[0][0] + (r/2) * Math.sin(theta + 0.3), pts[0][1] + (r/2) * Math.cos(theta + 0.3) ];
    const curvePoints = [];
    for (let t = 0; t <= 1.001; t += 0.01) {
        const x = (1-t)*(1-t)*pts[0][0] + 2*(1-t)*t*controlPoint[0] + t*t*pts[1][0];
        const y = (1-t)*(1-t)*pts[0][1] + 2*(1-t)*t*controlPoint[1] + t*t*pts[1][1];
        curvePoints.push([x, y]);
    }
    const polyline = L.polyline(curvePoints, { color: '#2563eb', weight: 3, dashArray: '5, 10', opacity: 0.7 }).addTo(map);

    // æ²¿æ›²çº¿å‡åŒ€åˆ†å¸ƒå¤šä¸ªæŒ‡å‘ç›®çš„åœ°çš„ç®­å¤´ï¼ˆçº¦ 6â€“8 ä¸ªï¼‰
    const numArrows = Math.min(8, Math.max(5, Math.floor(curvePoints.length / 12)));
    for (let a = 1; a <= numArrows; a++) {
        const t = a / (numArrows + 1);
        const arrowIndex = Math.floor(t * (curvePoints.length - 1));
        const arrowLatLng = curvePoints[arrowIndex];
        const i0 = Math.max(0, arrowIndex - 2);
        const i1 = Math.min(curvePoints.length - 1, arrowIndex + 2);
        const dx = curvePoints[i1][1] - curvePoints[i0][1];
        const dy = curvePoints[i1][0] - curvePoints[i0][0];
        const angleDeg = Math.atan2(dy, dx) * 180 / Math.PI;
        const arrowHtml = `<div class="route-arrow" style="transform: rotate(${angleDeg}deg);"></div>`;
        const arrowIcon = L.divIcon({
            className: 'route-arrow-icon',
            html: arrowHtml,
            iconSize: [14, 14],
            iconAnchor: [7, 7]
        });
        L.marker(arrowLatLng, { icon: arrowIcon, interactive: false }).addTo(map);
    }

    // å¤‡é™åœºè·¯çº¿ï¼šä»åˆ°è¾¾æœºåœºè¿åˆ°å¤‡é™åœºï¼Œä¸ ALTERNATE é¢œè‰²ä¸€è‡´
    let altLine = null;
    if (altP) {
        const altPts = [[arrP.lat, arrP.lon], [altP.lat, altP.lon]];
        altLine = L.polyline(altPts, { color: '#dc2626', weight: 2, dashArray: '4, 6', opacity: 0.8 }).addTo(map);
        L.circleMarker([altP.lat, altP.lon], { radius: 5, color: '#dc2626', fillColor: '#dc2626', fillOpacity: 1 }).addTo(map);
    }

    let bounds = polyline.getBounds();
    if (altLine) {
        bounds = bounds.extend(altLine.getBounds());
    }
    map.fitBounds(bounds, { padding: [80, 80], animate: false });

    mapInstances[idx] = map; routeLayers[idx] = polyline; altLayers[idx] = altLine || null; lastLegICAO[idx] = currentKey;
    
    setTimeout(() => { map.invalidateSize(); }, 50);
}

function draw() {
    const zone = document.getElementById('previewZone'); 
    const copyZone = document.getElementById('copy-zone');
    const vault = document.getElementById('permanent-vault');
    flightData.forEach((_, i) => { if (mapDoms[i]) vault.appendChild(mapDoms[i]); });
    zone.innerHTML = '';
    copyZone.innerHTML = '';

    flightData.forEach((leg, i) => {
        let imgs = (leg.imgs || []).map(s => `<img src="${s}">`).join('');
        let galleryHtml = imgs ? `<div class="gallery">${imgs}</div>` : '';
        let dWx = leg.depWx ? `<div class="weather-box"><span class="weather-label">DEPARTURE METAR (${leg.dep})</span><div class="weather-code">${leg.depWx}</div></div>` : '';
        let aWx = leg.arrWx ? `<div class="weather-box"><span class="weather-label">ARRIVAL METAR (${leg.arr})</span><div class="weather-code">${leg.arrWx}</div></div>` : '';
        
        let cleanCrz = leg.crz ? leg.crz.replace(/^FL\s*/i, '').trim() : '';
        const hasMultiLegs = flightData.length > 1;
        const legNoLabel = hasMultiLegs ? ` ${i + 1}` : '';

        // âœ¨ æ ¸å¿ƒè°ƒæ•´ï¼šè·ç¦»æ å®Œç¾å‚ç›´å¯¹é½
        let distHtml = leg.dist ? `
        <div class="metrics-divider" id="disp-metrics-divider-${i}">
            <div class="m-line"></div>
            <div class="m-data-area">
                <span class="m-label-sub">DIST</span>
                <span class="m-val-sub val-dist" id="disp-dist-val-${i}">${leg.dist} NM</span>
            </div>
            <div class="m-line"></div>
        </div>` : 
        `<div class="metrics-divider" id="disp-metrics-divider-${i}" style="display:none;">
            <div class="m-line"></div>
            <div class="m-data-area">
                <span class="m-label-sub">DIST</span>
                <span class="m-val-sub val-dist" id="disp-dist-val-${i}"></span>
            </div>
            <div class="m-line"></div>
        </div>`;

        let arcHtml = `
        <div class="crz-arc-container" id="disp-crz-arc-${i}" style="display: ${cleanCrz ? 'flex' : 'none'}">
             <svg class="crz-arc-svg" viewBox="0 0 400 55" preserveAspectRatio="none">
                 <path d="M 60 45 Q 200 8 340 45" /> </svg>
             <div class="crz-arc-text" id="disp-crz-text-${i}">FL${cleanCrz}</div>
        </div>`;

        zone.innerHTML += `
        <div class="card" id="card-leg-${i}">
            ${arcHtml}
            <div class="header">
                <div class="station align-left"><span class="m-title">DEPARTURE</span><div class="icao" id="disp-dep-${i}">${leg.dep || ''}</div><div class="cn-name" id="disp-depN-${i}">${leg.depN || ''}</div></div>
                <div class="route-visual">
                    <div class="plane-line-wrapper"><div class="line-segment"></div><div class="plane-box"><svg viewBox="0 0 24 24"><path transform="rotate(90 12 12)" d="M21,16L21,14L13,9L13,3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5L10,9L2,14L2,16L10,13.5L10,19L8,20.5L8,22L11.5,21L15,22L15,20.5L13,19L13,13.5L21,16Z"/></svg></div><div class="line-segment"></div></div>
                    <div class="callsign-text" id="disp-call-${i}">${leg.call || ''}</div>
                </div>
                <div class="station align-right"><span class="m-title">ARRIVAL</span><div class="icao" id="disp-arr-${i}">${leg.arr || ''}</div><div class="cn-name" id="disp-arrN-${i}">${leg.arrN || ''}</div></div>
            </div>
            
            ${distHtml}             <div class="meta-grid">
                <div class="meta-item align-left"><span class="m-title meta-acft">AIRCRAFT</span><div class="m-val" id="disp-acft-${i}">${leg.acft || ''}</div></div>
                <div class="meta-item align-center"><span class="m-title meta-altn">ALTERNATE</span><div class="m-val" style="color:var(--warn)" id="disp-alt-${i}">${leg.alt || ''}</div></div>
                <div class="meta-item align-center"><span class="m-title">STATUS</span><div class="m-val" style="color:#22c55e">RELEASED</div></div>
                <div class="meta-item align-right"><span class="m-title meta-utc">UTC TIME</span><div class="m-val">${new Date().getUTCHours().toString().padStart(2,'0')}:${new Date().getUTCMinutes().toString().padStart(2,'0')}Z</div></div>
            </div>

            <div class="route-zone">
                <div class="proc-grid">
                    <div class="proc-box"><div class="proc-label">DEP RWY</div><div class="proc-val rwy-val" id="disp-depRwy-${i}">${leg.depRwy || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">SID</div><div class="proc-val" style="color: #db2777;" id="disp-sid-${i}">${leg.sid || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">TRANS</div><div class="proc-val" style="color: #9333ea;" id="disp-depTrans-${i}">${leg.depTrans || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">STAR</div><div class="proc-val" style="color: #059669;" id="disp-star-${i}">${leg.star || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">TRANS</div><div class="proc-val" style="color: #ea580c;" id="disp-arrTrans-${i}">${leg.arrTrans || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">ARR RWY</div><div class="proc-val rwy-val" id="disp-arrRwy-${i}">${leg.arrRwy || ''}</div></div>
                </div>
                <div class="route-title">ENROUTE BRIEFING${legNoLabel}</div><div class="route-text" id="disp-rte-${i}">${leg.rte || ''}</div>
                <div id="disp-depWx-container-${i}">${dWx}</div>
                <div id="disp-arrWx-container-${i}">${aWx}</div>
            </div>
            <div id="map-placeholder-${i}" class="map-container"></div>${galleryHtml}
        </div>`;

        let routeParts = [];
        if(leg.dep) routeParts.push(leg.dep + (leg.depRwy ? '/' + leg.depRwy : ''));
        if(leg.sid) routeParts.push(leg.sid);
        if(leg.rte) routeParts.push(leg.rte);
        if(leg.star) routeParts.push(leg.star);
        if(leg.arr) routeParts.push(leg.arr + (leg.arrRwy ? '/' + leg.arrRwy : ''));
        let copyTextContent = routeParts.join(' ').trim();

        copyZone.innerHTML += `
        <div class="copy-section">
            <h3>ENROUTE BRIEFING${hasMultiLegs ? ' ' + (i + 1) : ''}
                <button class="copy-btn" onclick="copyTextData(${i}, this)">ä¸€é”®å¤åˆ¶</button>
            </h3>
            <textarea class="copy-textarea" id="copy-text-area-${i}" readonly>${copyTextContent}</textarea>
        </div>`;

        requestAnimationFrame(() => initMapForLeg(i));
    });
}
</script>
</body>
</html>