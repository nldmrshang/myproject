<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È£ûË°å‰ªªÂä°Á≠æÊ¥æ‰∏≠ÂøÉ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script src="airport_db.js"></script>
    <script src="airport_coords.js"></script>

    <style>
        :root { 
            --primary: #0f172a; --success: #059669; --warn: #dc2626; --bg: #f1f5f9; 
            --card: #ffffff; --border: #cbd5e1; --text: #1e293b; --accent: #2563eb; 
        }

        [data-theme="dark"] {
            --primary: #f8fafc; --bg: #020617; --card: #1e293b; 
            --border: #334155; --text: #f1f5f9; --accent: #38bdf8;
        }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; 
            display: flex; padding: 20px; gap: 40px; justify-content: center; 
            transition: background 0.3s, color 0.3s;
        }
        
        /* ÁºñËæëÈù¢Êùø */
        .editor { 
            width: 380px; background: var(--card); border-radius: 20px; padding: 25px; 
            border: 1px solid var(--border); height: 92vh; overflow-y: auto; 
            position: sticky; top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
        }
        .editor h2 { font-weight: 800; font-size: 20px; color: var(--primary); margin-bottom: 25px; }

        /* SimBrief ÂØºÂÖ•Âå∫ */
        .sb-import-area {
            background: var(--bg); border: 2px dashed var(--accent);
            border-radius: 12px; padding: 15px; margin-bottom: 20px;
        }
        .sb-import-area label { color: var(--accent); margin-top: 0; margin-bottom: 8px; font-weight: 900; }
        .sb-btn { 
            width: 100%; margin-top: 10px; padding: 10px; 
            background: var(--accent); color: #fff; border: none; 
            border-radius: 6px; font-weight: 800; cursor: pointer; transition: 0.2s;
        }
        
        /* ÊåâÈíÆÁªÑ */
        .btn-group { display: flex; flex-direction: row; gap: 8px; margin-bottom: 25px; justify-content: space-between; }
        .btn { 
            flex: 1; border: none; padding: 10px 4px; border-radius: 8px; 
            cursor: pointer; font-weight: 800; color: #fff; transition: 0.2s; font-size: 11px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); white-space: nowrap;
        }
        .add-btn { background: var(--accent); } 
        .reset-btn { background: #8b5cf6; }     
        .export-btn { background: #10b981; }    

        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        .leg-block { 
            background: var(--bg); padding: 20px; border-radius: 12px; 
            margin-bottom: 25px; border: 1px solid var(--border); 
        }
        
        label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; display: block; margin: 12px 0 5px; letter-spacing: 1px; }
        
        input, textarea { 
            width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 10px; 
            font-size: 14px; font-family: inherit; box-sizing: border-box; background: var(--card); outline: none; color: var(--text);
        }
        input { text-align: center; }
        textarea { text-align: left; resize: vertical; }
        
        .img-manage-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .img-thumb-wrapper { position: relative; width: 60px; height: 60px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
        .img-thumb { width: 100%; height: 100%; object-fit: cover; }
        .del-img-btn { position: absolute; top: 2px; right: 2px; background: var(--warn); color: #fff; border: none; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; font-size: 12px; display:flex; align-items:center; justify-content:center;}

        /* È¢ÑËßàÂå∫ */
        .preview { width: 850px; }
        #capture-area { padding: 40px; background: var(--border); border-radius: 30px; } 
        .card { background: var(--card); border-radius: 30px; padding: 45px; box-shadow: 0 30px 60px -12px rgba(0,0,0,0.15); position: relative; margin-bottom: 35px; color: var(--text); overflow: hidden;}
        
        .header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 25px; }
        .icao { font-size: 70px; font-weight: 900; color: var(--text); letter-spacing: -3px; line-height: 1; margin: 0; }
        .cn-name { font-size: 20px; font-weight: 800; color: var(--accent); margin-top: 12px; }
        
        /* Âú∞ÂõæÂÆπÂô® */
        .map-container { 
            width: 100%; height: 480px; background: var(--bg); border-radius: 16px; 
            margin-top: 25px; border: 1px solid var(--border); overflow: hidden; z-index: 1; position: relative;
        }
        [data-theme="dark"] .map-container { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }

        .route-visual { flex: 1; margin: 0 30px; margin-top: 25px; display: flex; flex-direction: column; align-items: center; }
        .plane-line-wrapper { display: flex; align-items: center; width: 100%; }
        .line-segment { flex: 1; height: 2px; background: var(--border); }
        .plane-box { 
            width: 46px; height: 46px; border: 2.5px solid var(--accent); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            background: var(--card); margin: 0 10px; 
        }
        .plane-box svg { width: 26px; fill: var(--accent); }
        .callsign-text { font-weight: 950; color: var(--accent); margin-top: 15px; font-size: 20px; letter-spacing: 1.5px; }

        .route-zone { background: var(--bg); border-radius: 16px; padding: 25px; border-left: 8px solid var(--accent); margin: 35px 0; }
        .proc-grid { display: grid; grid-template-columns: 1.1fr 1fr 1fr 1fr 1fr 1.1fr; gap: 8px; margin-bottom: 25px; }
        .proc-box { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px 4px; text-align: center; }
        .proc-label { font-size: 10px; font-weight: 800; color: var(--text); text-transform: uppercase; margin-bottom: 4px; }
        .proc-val { font-size: 18px; font-weight: 800; color: var(--text); }

        .route-title { font-size: 12px; font-weight: 800; color: var(--accent); margin-bottom: 12px; letter-spacing: 1.5px; }
        .route-text { font-family: "Courier New", Courier, monospace; font-size: 24px; font-weight: 800; color: var(--text); line-height: 1.5; word-break: break-all; white-space: pre-wrap; }
        
        .meta-grid { display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr; gap: 15px; border-top: 2px solid var(--bg); padding-top: 30px; }
        .m-title { font-size: 12px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1.5px; display: block; margin-bottom: 6px; }
        .m-val { font-size: 18px; font-weight: 800; color: var(--text); }
        
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 15px; margin-top: 25px; }
        .gallery img { width: 100%; border-radius: 14px; }

        .mode-toggle { padding: 8px 15px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; font-weight: 800; font-size: 12px; }
        
        .weather-box { margin-top: 10px; padding: 12px; border-radius: 8px; background: var(--card); border: 1px dashed var(--border); }
        .weather-label { font-size: 10px; font-weight: 900; color: var(--accent); margin-bottom: 4px; display: block; text-transform: uppercase;}
        .weather-code { font-family: "Courier New", Courier, monospace; font-size: 13px; font-weight: 700; color: var(--text); line-height: 1.4; word-break: break-all;}
    </style>
</head>
<body>

<div id="permanent-vault" style="display:none;"></div>

<datalist id="acft-list">
    <option value="Boeing 737-700"></option><option value="Boeing 737-800"></option>
    <option value="Boeing 737 MAX 8"></option><option value="Boeing 747-400"></option>
    <option value="Boeing 747-8i"></option><option value="Boeing 777-200ER"></option>
    <option value="Boeing 777-200LR"></option><option value="Boeing 777-300ER"></option>
    <option value="Boeing 777F"></option><option value="Boeing 787-8"></option>
    <option value="Boeing 787-9"></option><option value="Boeing 787-10"></option>
    <option value="Airbus A319"></option><option value="Airbus A320"></option>
    <option value="Airbus A320neo"></option><option value="Airbus A321"></option>
    <option value="Airbus A321neo"></option><option value="Airbus A330-200"></option>
    <option value="Airbus A330-300"></option><option value="Airbus A330-900neo"></option>
    <option value="Airbus A350-900"></option><option value="Airbus A350-1000"></option>
    <option value="Airbus A380-800"></option><option value="COMAC C919"></option>
    <option value="COMAC ARJ21"></option><option value="Embraer E190"></option>
    <option value="Bombardier CRJ-900"></option>
</datalist>

<div class="editor">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
        <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:28px;">‚úàÔ∏è</span>
            <h2>È£ûË°å‰ªªÂä°Á≠æÊ¥æ</h2>
        </div>
        <button class="mode-toggle" onclick="toggleDarkMode()" id="modeBtn">üåô ÈªëÂ§úÊ®°Âºè</button>
    </div>

    <div class="sb-import-area">
        <label>‚ö° SimBrief Ëß£Êûê</label>
        <textarea id="sb-raw-text" rows="3" placeholder="Âú®Ê≠§Á≤òË¥¥ SimBrief ÊñáÊú¨..."></textarea>
        <button class="sb-btn" onclick="parseSimBrief()">Ëß£ÊûêÂπ∂Ëá™Âä®Â°´ÂÖ•</button>
    </div>

    <div class="btn-group">
        <button class="btn add-btn" onclick="addNewLeg()">Â¢ûÂä†Ëà™ÊÆµ</button>
        <button class="btn reset-btn" onclick="resetAllMaps()">ÂØπÈΩêËà™Âõæ</button>
        <button class="btn export-btn" onclick="exportAsImage()">‰øùÂ≠òÂõæÁâá</button>
    </div>

    <div id="editorStack"></div>
</div>

<div class="preview">
    <div id="capture-area">
        <div id="previewZone"></div>
    </div>
</div>

<script>
let airportGeoData = {};
let mapInstances = {}; 
let mapDoms = {}; 
let routeLayers = {}; 
let lastLegICAO = {}; 

fetch('https://cdn.jsdelivr.net/gh/mwgg/Airports@master/airports.json')
    .then(res => res.json())
    .then(data => {
        airportGeoData = data;
        for (let icao in data) { 
            if (typeof DB !== 'undefined' && !DB[icao] && icao.length === 4) { 
                DB[icao] = data[icao].city || data[icao].name; 
            } 
        }
        draw();
    });

let flightData = [{ call: '', acft: '', dep: '', depN: '', depRwy: '', sid: '', depTrans: '', arr: '', arrN: '', arrTrans: '', star: '', arrRwy: '', alt: '', altN: '', rte: '', imgs: [], depWx: '', arrWx: '' }];

window.onload = () => { renderEditor(); draw(); };

function parseSimBrief() {
    const raw = document.getElementById('sb-raw-text').value;
    if (!raw) return alert("ËØ∑ÂÖàÁ≤òË¥¥ SimBrief ÊñáÊú¨ÂÜÖÂÆπÔºÅ");
    let idx = flightData.length - 1;
    const callMatch = raw.match(/ATC\s+C\/S\s+([A-Z0-9]+)/i);
    if (callMatch) flightData[idx].call = callMatch[1].trim();
    const acftMatch = raw.match(/\s(A\d{3}|B\d{3}|C\d{3}|MD\d{2})\s/i) || raw.match(/(?:FENIX\s+)(A\d{3})/i) || raw.match(/(?:AIRCRAFT:\s+)([A-Z0-9-]+)/i);
    if (acftMatch) flightData[idx].acft = acftMatch[1].trim();
    const depArrMatch = raw.match(/([A-Z]{4})\/[A-Z]{3}\s+([A-Z]{4})\/[A-Z]{3}/);
    if (depArrMatch) { 
        flightData[idx].dep = depArrMatch[1]; 
        flightData[idx].depN = (typeof DB !== 'undefined' && DB[depArrMatch[1]]) || ""; 
        flightData[idx].arr = depArrMatch[2]; 
        flightData[idx].arrN = (typeof DB !== 'undefined' && DB[depArrMatch[2]]) || ""; 
    }
    const altMatch = raw.match(/ALTN\s+([A-Z]{4})/i);
    if (altMatch) { flightData[idx].alt = altMatch[1]; flightData[idx].altN = (typeof DB !== 'undefined' && DB[altMatch[1]]) || ""; }
    const routeBlock = raw.match(/ROUTING:[\s\S]+?ROUTE ID:[\s\S]+?\n([\s\S]+?)\n\n/i);
    if (routeBlock) {
        let fullRte = routeBlock[1].replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
        let parts = fullRte.split(' ');
        if (parts[0].includes('/')) flightData[idx].depRwy = parts[0].split('/')[1];
        if (parts.length > 1) flightData[idx].sid = parts[1];
        let lastPart = parts[parts.length - 1];
        if (lastPart.includes('/')) flightData[idx].arrRwy = lastPart.split('/')[1];
        if (parts.length > 3) { let starCandidate = parts[parts.length - 2] === 'DCT' ? parts[parts.length - 3] : parts[parts.length - 2]; flightData[idx].star = starCandidate; }
        flightData[idx].rte = parts.slice(1, -1).join(' ');
    }
    const depWxMatch = raw.match(/Departure:[\s\S]+?SA\s+([\d]{6}\s+[\s\S]+?)(?=\n)/i);
    if (depWxMatch) flightData[idx].depWx = depWxMatch[1].trim();
    const arrWxMatch = raw.match(/Destination:[\s\S]+?SA\s+([\d]{6}\s+[\s\S]+?)(?=\n)/i);
    if (arrWxMatch) flightData[idx].arrWx = arrWxMatch[1].trim();
    renderEditor(); draw(); 
}

function toggleDarkMode() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
    document.getElementById('modeBtn').innerText = isDark ? 'üåô ÈªëÂ§úÊ®°Âºè' : '‚òÄÔ∏è ÁôΩÂ§©Ê®°Âºè';
    Object.values(mapInstances).forEach(m => m.invalidateSize());
    draw();
}

function resetAllMaps() {
    Object.keys(mapInstances).forEach(idx => {
        const map = mapInstances[idx];
        const layer = routeLayers[idx];
        if (map && layer) {
            map.invalidateSize();
            map.fitBounds(layer.getBounds(), { padding: [100, 100], animate: true });
        }
    });
}

async function fetchMetar(idx, type) {
    const icao = type === 'dep' ? flightData[idx].dep : flightData[idx].arr;
    if (!icao || icao.length < 4) return alert("ËØ∑ËæìÂÖ•Êú∫Âú∫ ICAO");
    const btn = event.target; btn.innerText = "...";
    try {
        const response = await fetch(`https://metar.vatsim.net/metar.php?id=${icao.toUpperCase()}`);
        const data = await response.text();
        if (data && data.length > 5) { flightData[idx][type + 'Wx'] = data.trim(); renderEditor(); draw(); }
    } catch (e) { alert("ÁΩëÁªúÈîôËØØ"); } finally { btn.innerText = type === 'dep' ? "Ëµ∑È£ûÂ§©Ê∞î" : "Âà∞ËææÂ§©Ê∞î"; }
}

function deleteWx(idx, type) { flightData[idx][type + 'Wx'] = ''; renderEditor(); draw(); }

// ‚ú® ‰øÆÂ§çÂêéÁöÑÊà™ÂõæÂáΩÊï∞ÔºöÈöêËóèÂú∞Âõæ + ÊûÅÈÄüÂìçÂ∫î
function exportAsImage() {
    const target = document.getElementById('capture-area');
    const btn = document.querySelector('.export-btn');
    btn.innerText = "ÁîüÊàê‰∏≠..."; btn.disabled = true;
    
    // Âº∫Âà∂ÂõûÂà∞È°µÈù¢È°∂ÈÉ®ÔºåÈò≤Ê≠¢Êà™ÂõæÂÅèÁßª
    window.scrollTo(0, 0);

    html2canvas(target, { 
        useCORS: true, 
        scale: 3, 
        backgroundColor: null,
        onclone: (clonedDoc) => {
            // ‚ú® ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂú®Êà™ÂõæÂâØÊú¨‰∏≠ÂΩªÂ∫ïÈöêËóèÂú∞ÂõæÂÆπÂô®
            const maps = clonedDoc.querySelectorAll('.map-container');
            maps.forEach(m => { m.style.display = 'none'; });
        }
    }).then(canvas => {
        const link = document.createElement('a'); 
        link.download = `Dispatch_${flightData[0].call || 'Plan'}.png`;
        link.href = canvas.toDataURL("image/png"); 
        link.click();
        btn.innerText = "‰øùÂ≠òÂõæÁâá"; btn.disabled = false;
    });
}

function autoInput(idx, field, el) {
    const code = el.value.toUpperCase(); 
    flightData[idx][field] = code;
    const nameField = field + 'N';
    const airportName = (typeof DB !== 'undefined' && DB[code]) ? DB[code] : '';
    flightData[idx][nameField] = airportName;
    const targetInput = document.getElementById(`${nameField}-${idx}`);
    if (targetInput) targetInput.value = airportName;
    draw();
}

function updateData(idx, field, val) { 
    flightData[idx][field] = val; 
    draw(); 
}

function addNewLeg() {
    const lastLeg = flightData[flightData.length - 1];
    flightData.push({ call: lastLeg.call, acft: lastLeg.acft, dep: lastLeg.arr, depN: lastLeg.arrN, depRwy: '', sid: '', depTrans: '', arr: '', arrN: '', arrTrans: '', star: '', arrRwy: '', alt: '', altN: '', rte: '', imgs: [], depWx: '', arrWx: '' });
    renderEditor(); draw();
}

function deleteLeg(idx) {
    if (flightData.length > 1) { flightData.splice(idx, 1); renderEditor(); draw(); }
}

function handleFiles(e, idx) {
    Array.from(e.target.files).forEach(f => {
        let r = new FileReader(); r.onload = (ev) => { flightData[idx].imgs.push(ev.target.result); renderEditor(); draw(); }; r.readAsDataURL(f);
    });
}

function deleteImg(legIdx, imgIdx) { flightData[legIdx].imgs.splice(imgIdx, 1); renderEditor(); draw(); }

function renderEditor() {
    const stack = document.getElementById('editorStack'); stack.innerHTML = '';
    flightData.forEach((leg, i) => {
        const div = document.createElement('div'); div.className = 'leg-block';
        let imgsHtml = (leg.imgs || []).map((img, imgIdx) => `<div class="img-thumb-wrapper"><img src="${img}" class="img-thumb"><button class="del-img-btn" onclick="deleteImg(${i}, ${imgIdx})">√ó</button></div>`).join('');
        let deleteBtnHtml = flightData.length > 1 ? `<button onclick="deleteLeg(${i})" style="background:none; border:none; color:var(--warn); cursor:pointer; font-weight:800; font-size:12px; padding:0;">[Âà†Èô§ÊÆµ]</button>` : '';
        let wxButtonsHtml = `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;"><div style="display:flex; gap:5px;"><button onclick="fetchMetar(${i}, 'dep')" style="flex:1; background:var(--accent); color:#fff; border:none; border-radius:6px; font-size:10px; padding:6px; cursor:pointer;">Ëµ∑È£ûÂ§©Ê∞î</button><button onclick="deleteWx(${i}, 'dep')" style="background:var(--warn); color:#fff; border:none; border-radius:6px; font-size:10px; width:30px; cursor:pointer;">Êí§</button></div><div style="display:flex; gap:5px;"><button onclick="fetchMetar(${i}, 'arr')" style="flex:1; background:var(--accent); color:#fff; border:none; border-radius:6px; font-size:10px; padding:6px; cursor:pointer;">Âà∞ËææÂ§©Ê∞î</button><button onclick="deleteWx(${i}, 'arr')" style="background:var(--warn); color:#fff; border:none; border-radius:6px; font-size:10px; width:30px; cursor:pointer;">Êí§</button></div></div>`;
        div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;"><span style="font-size:12px; font-weight:800; color:#64748b;">Ëà™ÊÆµ ${i + 1}</span>${deleteBtnHtml}</div><div style="display:flex; gap:10px;"><div style="flex:1;"><label>Ëà™Áè≠Âè∑</label><input type="text" value="${leg.call}" oninput="updateData(${i}, 'call', this.value)"></div><div style="flex:1;"><label>Êú∫Âûã</label><input type="text" list="acft-list" value="${leg.acft}" oninput="updateData(${i}, 'acft', this.value)"></div></div><div style="display:flex; gap:10px;"><div style="flex:1;"><label>Ëµ∑È£û ICAO</label><input type="text" value="${leg.dep}" maxlength="4" oninput="autoInput(${i}, 'dep', this)"></div><div style="flex:1;"><label>Âà∞Ëææ ICAO</label><input type="text" value="${leg.arr}" maxlength="4" oninput="autoInput(${i}, 'arr', this)"></div></div><div style="display:flex; gap:10px; margin-top:8px;"><input type="text" id="depN-${i}" value="${leg.depN}" oninput="updateData(${i}, 'depN', this.value)"><input type="text" id="arrN-${i}" value="${leg.arrN}" oninput="updateData(${i}, 'arrN', this.value)"></div>${wxButtonsHtml}<div style="display:flex; gap:10px; margin-top:5px;"><div style="flex:1;"><label>Á¶ªÂú∫Ë∑ëÈÅì</label><input type="text" value="${leg.depRwy}" oninput="updateData(${i}, 'depRwy', this.value)"></div><div style="flex:1.5;"><label>Á¶ªÂú∫Á®ãÂ∫è</label><input type="text" value="${leg.sid}" oninput="updateData(${i}, 'sid', this.value)"></div><div style="flex:1;"><label>Á¶ªÂú∫ËøáÊ∏°</label><input type="text" value="${leg.depTrans}" oninput="updateData(${i}, 'depTrans', this.value)"></div></div><div style="display:flex; gap:10px;"><div style="flex:1;"><label>ËøõÂú∫Ë∑ëÈÅì</label><input type="text" value="${leg.arrRwy}" oninput="updateData(${i}, 'arrRwy', this.value)"></div><div style="flex:1.5;"><label>ËøõÂú∫Á®ãÂ∫è</label><input type="text" value="${leg.star}" oninput="updateData(${i}, 'star', this.value)"></div><div style="flex:1;"><label>ËøõÂú∫ËøáÊ∏°</label><input type="text" value="${leg.arrTrans}" oninput="updateData(${i}, 'arrTrans', this.value)"></div></div><label>Â§áÈôç ALTN</label><div style="display:flex; gap:10px;"><input type="text" value="${leg.alt}" maxlength="4" oninput="autoInput(${i}, 'alt', this)" style="flex:1;"><input type="text" id="altN-${i}" value="${leg.altN}" oninput="updateData(${i}, 'altN', this.value)" style="flex:2;"></div><label>Ëà™Ë∑Ø‰ø°ÊÅØ</label><textarea rows="3" oninput="updateData(${i}, 'rte', this.value)">${leg.rte}</textarea><label>ÈôÑ‰ª∂ÂõæÁâá</label><input type="file" multiple accept="image/*" onchange="handleFiles(event, ${i})"><div class="img-manage-list">${imgsHtml}</div>`;
        stack.appendChild(div);
    });
}

function initMapForLeg(idx) {
    const depICAO = flightData[idx].dep; const arrICAO = flightData[idx].arr;
    const container = document.getElementById(`map-placeholder-${idx}`);
    if (!container) return;
    let depP, arrP;
    if (typeof COORDS_DB !== 'undefined' && COORDS_DB[depICAO]) {
        depP = { lat: COORDS_DB[depICAO][0], lon: COORDS_DB[depICAO][1] };
    } else if (airportGeoData[depICAO]) {
        depP = { lat: airportGeoData[depICAO].lat, lon: airportGeoData[depICAO].lon };
    }
    if (typeof COORDS_DB !== 'undefined' && COORDS_DB[arrICAO]) {
        arrP = { lat: COORDS_DB[arrICAO][0], lon: COORDS_DB[arrICAO][1] };
    } else if (airportGeoData[arrICAO]) {
        arrP = { lat: airportGeoData[arrICAO].lat, lon: airportGeoData[arrICAO].lon };
    }
    if (!depP || !arrP) { container.innerHTML = ""; return; }
    const currentKey = `${depICAO}-${arrICAO}`;
    if (lastLegICAO[idx] === currentKey && mapDoms[idx]) { container.appendChild(mapDoms[idx]); if (mapInstances[idx]) mapInstances[idx].invalidateSize(); return; }
    if (mapInstances[idx]) mapInstances[idx].remove();
    const mapDiv = document.createElement('div'); mapDiv.className = 'map-container';
    container.appendChild(mapDiv); mapDoms[idx] = mapDiv;
    const map = L.map(mapDiv, { zoomControl: false, attributionControl: false, fadeAnimation: false, zoomAnimation: false });
    L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', { subdomains: ['1', '2', '3', '4'] }).addTo(map);
    const pts = [[depP.lat, depP.lon], [arrP.lat, arrP.lon]];
    L.circleMarker(pts[0], { radius: 5, color: '#2563eb', fillOpacity: 1 }).addTo(map);
    L.circleMarker(pts[1], { radius: 5, color: '#2563eb', fillOpacity: 1 }).addTo(map);
    
    // ‚ú® ‰øÆÂ§çÂêéÁöÑÈ´òÁ≤æÂ∫¶ÂºßÁ∫øËÆ°ÁÆó
    const offsetX = pts[1][1] - pts[0][1]; const offsetY = pts[1][0] - pts[0][0];
    const r = Math.sqrt(Math.pow(offsetX, 2) + Math.pow(offsetY, 2)); const theta = Math.atan2(offsetY, offsetX);
    const controlPoint = [ pts[0][0] + (r/2) * Math.sin(theta + 0.3), pts[0][1] + (r/2) * Math.cos(theta + 0.3) ];
    const curvePoints = [];
    // Â¢ûÂä†Ê≠•ÈïøÂØÜÂ∫¶Ôºà0.01ÔºâÔºåÁ°Æ‰øùÁªàÁÇπÁªùÂØπÂØπÈΩê
    for (let t = 0; t <= 1.001; t += 0.01) {
        const x = (1-t)*(1-t)*pts[0][0] + 2*(1-t)*t*controlPoint[0] + t*t*pts[1][0];
        const y = (1-t)*(1-t)*pts[0][1] + 2*(1-t)*t*controlPoint[1] + t*t*pts[1][1];
        curvePoints.push([x, y]);
    }
    const polyline = L.polyline(curvePoints, { color: '#2563eb', weight: 3, dashArray: '5, 10', opacity: 0.6 }).addTo(map);
    map.fitBounds(polyline.getBounds(), { padding: [100, 100], animate: false });
    mapInstances[idx] = map; routeLayers[idx] = polyline; lastLegICAO[idx] = currentKey;
}

function draw() {
    const zone = document.getElementById('previewZone'); const vault = document.getElementById('permanent-vault');
    flightData.forEach((_, i) => { if (mapDoms[i]) vault.appendChild(mapDoms[i]); });
    zone.innerHTML = '';
    flightData.forEach((leg, i) => {
        let imgs = (leg.imgs || []).map(s => `<img src="${s}">`).join('');
        let galleryHtml = imgs ? `<div class="gallery">${imgs}</div>` : '';
        let dWx = leg.depWx ? `<div class="weather-box"><span class="weather-label">DEPARTURE METAR (${leg.dep})</span><div class="weather-code">${leg.depWx}</div></div>` : '';
        let aWx = leg.arrWx ? `<div class="weather-box"><span class="weather-label">ARRIVAL METAR (${leg.arr})</span><div class="weather-code">${leg.arrWx}</div></div>` : '';
        zone.innerHTML += `
        <div class="card">
            <div class="header">
                <div class="station"><span class="m-title">DEPARTURE</span><div class="icao">${leg.dep || ''}</div><div class="cn-name">${leg.depN || ''}</div></div>
                <div class="route-visual">
                    <div class="plane-line-wrapper"><div class="line-segment"></div><div class="plane-box"><svg viewBox="0 0 24 24"><path transform="rotate(90 12 12)" d="M21,16L21,14L13,9L13,3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5L10,9L2,14L2,16L10,13.5L10,19L8,20.5L8,22L11.5,21L15,22L15,20.5L13,19L13,13.5L21,16Z"/></svg></div><div class="line-segment"></div></div>
                    <div class="callsign-text">${leg.call || ''}</div>
                </div>
                <div class="station" style="text-align:right;"><span class="m-title">ARRIVAL</span><div class="icao">${leg.arr || ''}</div><div class="cn-name">${leg.arrN || ''}</div></div>
            </div>
            <div class="meta-grid">
                <div style="text-align: left;"><span class="m-title">AIRCRAFT</span><div class="m-val">${leg.acft || ''}</div></div>
                <div><div style="display: inline-block; text-align: center;"><span class="m-title">ALTERNATE</span><div class="m-val" style="color:var(--warn)">${leg.alt || ''}</div></div></div>
                <div><span class="m-title">STATUS</span><div class="m-val" style="color:var(--success)">RELEASED</div></div>
                <div style="text-align: right;"><span class="m-title">UTC TIME</span><div class="m-val">${new Date().getUTCHours().toString().padStart(2,'0')}:${new Date().getUTCMinutes().toString().padStart(2,'0')}Z</div></div>
            </div>
            <div class="route-zone">
                <div class="proc-grid">
                    <div class="proc-box"><div class="proc-label">DEP RWY</div><div class="proc-val">${leg.depRwy || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">SID</div><div class="proc-val" style="color: #db2777;">${leg.sid || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">TRANS</div><div class="proc-val" style="color: #9333ea;">${leg.depTrans || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">STAR</div><div class="proc-val" style="color: #059669;">${leg.star || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">TRANS</div><div class="proc-val" style="color: #ea580c;">${leg.arrTrans || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">ARR RWY</div><div class="proc-val">${leg.arrRwy || ''}</div></div>
                </div>
                <div class="route-title">ENROUTE BRIEFING</div><div class="route-text">${leg.rte || ''}</div>${dWx}${aWx}
            </div>
            <div id="map-placeholder-${i}" class="map-container"></div>${galleryHtml}
        </div>`;
        requestAnimationFrame(() => initMapForLeg(i));
    });
}
</script>
</body>
</html>