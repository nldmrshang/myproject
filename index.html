<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è¡Œä»»åŠ¡ç­¾æ´¾ä¸­å¿ƒ</title>
    
    <script>window.L_DISABLE_3D = true;</script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script src="airport_db.js"></script>
    <script src="airport_coords.js"></script>
    <script src="aircraft_db.js"></script>

    <style>
        :root { 
            --primary: #0f172a; --success: #059669; --warn: #dc2626; --bg: #eef2f7; 
            --card: #ffffff; --border: #cbd5e1; --text: #1e293b; --accent: #2563eb; 
            --crz-color: #f59e0b; /* å·¡èˆªé«˜åº¦å¼ºè°ƒè‰² */
            --radius-ui: 12px; /* ç»Ÿä¸€åœ†è§’ï¼šè§£æåŒºã€æ‚¬æµ®æ“ä½œæ¡åŠå†…éƒ¨æŒ‰é’® */
            --card-border-gradient: linear-gradient(90deg, rgba(37,99,235,0.4), rgba(16,185,129,0.4)); /* é»˜è®¤æ¸å˜ï¼Œåç»­ç”¨ JS éšæœºè¦†ç›– */
        }

        [data-theme="dark"] {
            --primary: #f8fafc; --bg: #020617; --card: #1e293b; 
            --border: #334155; --text: #f1f5f9; --accent: #38bdf8;
        }
        *, *::before, *::after { box-sizing: border-box; }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; 
            display: flex; padding: 20px; gap: 40px; justify-content: center; 
            transition: background 0.3s, color 0.3s;
            text-shadow: 0 1px 2px rgba(15, 23, 42, 0.18);
        }
        
        .editor { 
            width: 340px; background: var(--card); border-radius: 20px; padding: 22px; 
            border: 1px solid var(--border); height: 92vh; overflow-y: auto; 
            position: sticky; top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
        }
        .editor h2 { font-weight: 800; font-size: 20px; color: var(--primary); margin-bottom: 25px; }

        .sb-import-area {
            background: var(--bg); border: 1px solid var(--border);
            border-radius: var(--radius-ui); padding: 12px; margin-bottom: 12px;
        }
        .sb-import-area label { color: var(--accent); margin-top: 0; margin-bottom: 8px; font-weight: 900; }
        .sb-btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .sb-btn { 
            flex: 1; padding: 10px; 
            background: var(--accent); color: #fff; border: none; 
            border-radius: var(--radius-ui); font-weight: 800; cursor: pointer; transition: 0.2s;
        }
        .sb-btn-clip { background: #8b5cf6; }
        .sb-btn-api {
            background: #8b5cf6;
            border-radius: var(--radius-ui);
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 800;
            min-width: 0;
        }
        .simbrief-id-icon {
            height: 20px;
            width: auto;
            vertical-align: middle;
            display: block;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.15));
        }
        .simbrief-id-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(0,0,0,0.22);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.15), 0 2px 6px rgba(0,0,0,0.2);
        }
        .simbrief-id-wrap .simbrief-id-icon {
            height: 18px;
        }
        .simbrief-id-fallback {
            font-size: 12px;
            font-weight: 800;
            color: var(--text);
        }
        .simbrief-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .simbrief-row .simbrief-id-wrap {
            flex-shrink: 0;
        }
        .simbrief-id-input {
            flex: 1;
            min-width: 0;
            max-width: 200px;
            padding: 6px 10px;
            font-size: 13px;
            font-family: inherit;
            border: 1px solid var(--border);
            border-radius: 8px;
            line-height: 1.3;
            background: var(--bg);
            color: var(--text);
            outline: none;
        }
        .simbrief-id-input:focus { border-color: var(--accent); }
        .simbrief-row .sb-btn-api {
            flex-shrink: 0;
        }
        
        .btn-group { display: flex; flex-direction: row; gap: 8px; justify-content: space-between; flex-wrap: wrap; }
        .btn { 
            flex: 1; border: none; padding: 10px 4px; border-radius: var(--radius-ui); 
            cursor: pointer; font-weight: 800; color: #fff; transition: 0.2s; font-size: 11px; 
            box-shadow: 0 2px 4px rgba(15,23,42,0.25); white-space: nowrap; min-width: 22%;
        }
        .add-btn { background: var(--accent); } 
        .reset-btn { background: #8b5cf6; }     
        .export-btn { background: #10b981; }  
        .html-btn { background: #f59e0b; }

        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* å³ä¾§æ‚¬æµ®å·¥å…·æ¡ï¼šæ¯é¡¹é¢œè‰²åŒºåˆ†æ˜æ˜¾ */
        .floating-controls .add-btn { background: #2563eb; }
        .floating-controls .reset-btn:nth-child(2) { background: #0d9488; }
        .floating-controls #mapExportToggleBtn_floating { background: #6366f1 !important; }
        .floating-controls .export-btn { background: #059669; }
        .floating-controls .html-btn { background: #ea580c; }
        .floating-controls .sb-btn { background: #475569 !important; }

        .leg-block { 
            background: var(--bg); padding: 15px; border-radius: 12px; 
            margin-bottom: 25px; border: 1px solid var(--border); 
            animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .leg-flip-highlight {
            animation: legFlipIn 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            transform-origin: center;
        }
        
        .editor-group {
            background: var(--card); 
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .editor-group-title {
            font-size: 13px;
            font-weight: 900;
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; display: block; margin: 0 0 5px; letter-spacing: 1px; }
        
        input, textarea { 
            width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 8px; 
            font-size: 13px; font-family: inherit; box-sizing: border-box; background: var(--bg); outline: none; color: var(--text);
            transition: border 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--accent); }
        input { text-align: center; }
        textarea { text-align: left; resize: vertical; }
        
        .img-manage-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .img-thumb-wrapper { position: relative; width: 60px; height: 60px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
        .img-thumb { width: 100%; height: 100%; object-fit: cover; }
        .del-img-btn { position: absolute; top: 2px; right: 2px; background: var(--warn); color: #fff; border: none; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; font-size: 12px; display:flex; align-items:center; justify-content:center;}
        .mode-toggle { padding: 8px 15px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; font-weight: 800; font-size: 12px; }

        .floating-controls {
            position: fixed;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 20;
            background: var(--card);
            border-radius: var(--radius-ui);
            box-shadow: 0 18px 40px rgba(15,23,42,0.25);
            border: 1px solid var(--border);
            padding: 8px 6px;
        }
        .floating-controls-toggle {
            display: none;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 44px;
            padding: 12px 20px;
            margin-bottom: 8px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: var(--radius-ui);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .floating-controls-toggle:last-child { margin-bottom: 0; }
        .floating-controls.collapsed .floating-controls-toggle { margin-bottom: 0; }
        .floating-btn-group {
            flex-direction: column;
            gap: 6px;
        }
        .floating-btn-group .btn { border-radius: var(--radius-ui); }

        @keyframes slideUpFade {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes legFlipIn {
            0% { opacity: 0; transform: rotateY(-70deg) translateY(8px); }
            60% { opacity: 1; transform: rotateY(8deg) translateY(0); }
            100% { opacity: 1; transform: rotateY(0deg) translateY(0); }
        }
        @keyframes pulse-icon {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(37, 99, 235, 0); }
            50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(37, 99, 235, 0); }
        }

        .no-animation, .no-animation * {
            animation: none !important;
            transition: none !important;
            opacity: 1 !important; 
        }

        .preview { width: 850px; max-width: 100%; }
        .copy-zone-wrap {
            width: 100%;
            margin-top: 20px;
            padding: 40px;
            background: #d1d5db;
            border-radius: 30px;
            box-sizing: border-box;
            transition: background 0.3s;
        }
        [data-theme="dark"] .copy-zone-wrap { background: var(--bg); }
        #copy-zone { 
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
        }
        #capture-area { 
            padding: 24px 40px 40px; background: #d1d5db; border-radius: 30px; transition: background 0.3s;
            display: flex; flex-direction: column; align-items: center;
        } 
        
        /* æŒ‰å­—ä½“ä¸é—´è·è®¡ç®—é«˜åº¦ï¼Œé¦–å±å³å ä½é¿å…æŠ–åŠ¨ */
        #previewZone { width: 100%; max-width: 850px; min-width: 0; display: flex; flex-direction: column; align-items: center; }
        .card { 
            width: 100%; max-width: 850px; box-sizing: border-box;
            border-radius: 30px; padding: 45px 45px 45px; 
            box-shadow: 0 30px 60px -12px rgba(0,0,0,0.15); position: relative; 
            margin: 20px 25px 30px 25px; color: var(--text); overflow: hidden;
            min-width: 0;
            min-height: 1140px;
            opacity: 0; animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            border: 5px solid transparent;
            background-image: linear-gradient(var(--card), var(--card)), var(--card-border-gradient);
            background-origin: padding-box, border-box;
            background-clip: padding-box, border-box;
        }
        /* ä¸å«åœ°å›¾æ—¶å¡ç‰‡é«˜åº¦éšå†…å®¹ï¼Œé¿å…æˆªå›¾å¤§ç‰‡ç©ºç™½ */
        .no-map .card { min-height: auto; }
        .capture-no-border .card,
        .capture-no-border .copy-section-in-card,
        .capture-no-border .copy-section {
            border: 1px solid var(--border) !important;
            background-image: none !important;
            background: var(--card) !important;
            background-origin: unset !important;
            background-clip: unset !important;
        }
        
        .header { 
            display: grid; 
            grid-template-columns: auto minmax(0, 1fr) auto; 
            grid-template-rows: auto;
            align-items: center; 
            margin-bottom: 20px; 
            position: relative;
            padding-top: 60px;
            min-height: 220px;
            box-sizing: border-box;
        }
        .plane-lines-wrap {
            grid-column: 1 / -1;
            grid-row: 1;
            position: relative;
            width: 100%;
            height: 0;
            margin-top: 1px;
            z-index: 0;
            pointer-events: none;
        }
        .plane-line-left,
        .plane-line-right {
            position: absolute;
            top: 0;
            height: 3px;
            background: rgba(100, 116, 139, 0.5);
        }
        .plane-line-left {
            left: var(--line-left-start, 88px);
            right: 50%;
            margin-right: 39px;
            width: auto;
        }
        .plane-line-right {
            left: 50%;
            margin-left: 39px;
            right: var(--line-right-end, 88px);
            width: auto;
        }

        .station { display: flex; flex-direction: column; overflow: visible; }
        .station.align-left { align-items: flex-start; text-align: left; grid-column: 1; grid-row: 1; z-index: 1; }
        .station.align-right { align-items: flex-end; text-align: right; grid-column: 3; grid-row: 1; z-index: 1; transform: translateY(-10px); }
        .icao { font-size: 82px; font-weight: 400; color: var(--text); letter-spacing: -3px; line-height: 1; margin: 0; }
        .cn-name { font-size: 20px; font-weight: 800; color: var(--accent); margin-top: 10px; line-height: 1.3; min-height: 1.3em; visibility: visible; }
        
        .route-visual { 
            grid-column: 2; grid-row: 1; z-index: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; min-width: 0;
        }
        .plane-center-fixed {
            grid-column: 1 / -1;
            grid-row: 1;
            position: absolute;
            left: 50%;
            top: 53px;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
            pointer-events: none;
        }
        .plane-center-fixed .plane-box { pointer-events: auto; }
        
        .crz-arc-container {
            position: absolute;
            top: 21px;
            left: 0;
            right: 0;
            width: 100%;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 0;
        }
        .crz-arc-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            fill: none;
            stroke: #2563eb; /* æ›´æ¥è¿‘åœ°çƒè“çš„æ·±è“è‰² */
            stroke-width: 2;
            stroke-dasharray: 4 4; /* ç‚¹æ›´å¯†é›† */
            opacity: 1;
        }
        .crz-arc-text {
            position: relative;
            background: var(--card);
            padding: 3px 10px;
            border-radius: 12px;
            border: 1.5px solid var(--crz-color);
            color: var(--crz-color);
            font-weight: 400;
            font-size: 17px;
            z-index: 2;
            box-shadow: 0 3px 10px rgba(245, 158, 11, 0.2);
            transform: translateY(2px);
        }

        .plane-box { 
            flex-shrink: 0;
            width: 50px; height: 50px; border: 2.5px solid var(--accent); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            background: var(--card); margin: 0 15px; transition: all 0.3s ease; position: relative; z-index: 1;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.28);
        }
        .plane-box:hover { animation: pulse-icon 1.5s infinite; }
        .plane-box svg { width: 28px; fill: var(--accent); }
        .callsign-text { font-weight: 950; color: #7c3aed; margin-top: 5px; font-size: 22px; letter-spacing: 1.5px; z-index: 1; }

        .metrics-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-top: -14px;
            margin-bottom: 25px;
            height: 42px;
            min-height: 42px;
            flex-shrink: 0;
            position: relative;
            z-index: 2;
        }
        .m-line {
            flex: 1;
            height: 0;
            border-top: 3px dashed #6d4c41;
            opacity: 1;
        }
        .m-data-area {
            display: flex;
            align-items: center; /* åŒºåŸŸå†…æ–‡å­—å‚ç›´å±…ä¸­ */
            gap: 16px;
            padding: 0 40px;
            height: 100%;
        }
        .m-label-sub {
            font-size: 26px; 
            font-weight: 400; 
            color: #94a3b8; 
            letter-spacing: 1px;
            margin: 0;
            line-height: 1;
            padding-top: 0;
            text-shadow: none;
        }
        .m-val-sub {
            font-size: 26px; 
            font-weight: 400; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1; 
            margin: 0;
            text-shadow: none;
        }
        .val-dist { color: var(--accent); }

        .map-wrapper {
            width: 100%; height: 360px; min-height: 360px;
            margin-top: 0;
            overflow: hidden;
            border-radius: 16px;
            position: relative;
        }
        .map-container { 
            width: 100%; height: 100%; min-height: 360px; background: var(--bg); border-radius: 16px; 
            margin: 0;
            border: none;
            overflow: hidden; z-index: 1; position: absolute; left: 0; top: 0; right: 0; bottom: 0;
            box-shadow: none;
            opacity: 0; animation: slideUpFade 0.6s 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .map-container .leaflet-container { background: #e8eef4 !important; border: none !important; }
        .map-container .leaflet-control-container .leaflet-top,
        .map-container .leaflet-control-container .leaflet-bottom { z-index: 999; }
        .map-container .leaflet-control { border: none !important; box-shadow: none !important; }
        .map-container a.leaflet-control-zoom { border: none !important; }
        [data-theme="dark"] .map-container { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        /* å¯¼å‡ºæ— åœ°å›¾æ¨¡å¼ï¼šä»…éšè—åœ°å›¾ï¼Œä¸å½±å“æ•´ä½“å¸ƒå±€ç»“æ„ */
        .no-map .map-wrapper,
        .no-map .map-container {
            display: none !important;
        }
        .no-map .copy-section-in-card {
            display: none !important;
        }
        .route-arrow {
            width: 10px;
            height: 10px;
            background: #1d4ed8;
            clip-path: polygon(50% 0%, 100% 100%, 50% 85%, 0% 100%);
            box-shadow: 0 0 0 1px rgba(255,255,255,0.6);
        }
        .route-arrow-icon { background: none !important; border: none !important; }

        .route-zone { 
            background: var(--bg); border-radius: 16px; padding: 18px 28px; border-left: 8px solid var(--accent); 
            margin: 28px 0; transition: transform 0.3s ease, box-shadow 0.3s ease;
            min-height: 170px;
            flex-shrink: 0;
            max-width: 680px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
        }
        .route-zone:hover { transform: translateX(6px); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .proc-grid { display: grid; grid-template-columns: 1.1fr 1fr 1fr 1fr 1fr 1.1fr; gap: 8px; margin-bottom: 14px; min-width: 0; }
        .proc-box { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 11px 6px; text-align: center; }
        .proc-label { font-size: 14px; font-weight: 400; color: var(--text); text-transform: uppercase; margin-bottom: 4px; }
        .proc-val { font-size: 20px; font-weight: 400; color: var(--text); }
        .proc-val.rwy-val { color: #0891b2; }

        .route-title { font-size: 14px; font-weight: 800; color: var(--accent); margin-bottom: 8px; letter-spacing: 1.5px; }
        .route-text { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; font-size: 15px; font-weight: 700; color: var(--text); line-height: 1.6; word-break: break-all; white-space: pre-wrap; }
        
        .meta-grid { 
            display: flex; justify-content: space-between; align-items: flex-start; 
            border-top: 4px solid #1e293b; padding-top: 32px; width: 100%;
            min-height: 78px;
            flex-shrink: 0;
            margin-bottom: 28px;
        }
        .meta-item { display: flex; flex-direction: column; flex: 1; }
        .meta-item.align-left { align-items: flex-start; text-align: left; }
        .meta-item.align-center { align-items: center; text-align: center; }
        .meta-item.align-right { align-items: center; text-align: right; }
        .m-title { font-size: 13px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 1.5px; display: block; margin-bottom: 6px; text-shadow: none; }
        .station .m-title {
            font-size: 14px;
            color: #0ea5e9;
        }
        .m-title.meta-acft { color: #64748b; }
        .m-title.meta-altn { color: #64748b; }
        .m-title.meta-utc { color: #64748b; }
        .m-val { font-size: 20px; font-weight: 800; color: var(--text); text-shadow: none; }
        
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 15px; margin-top: 25px; }
        .gallery img { width: 100%; border-radius: 14px; }
        
        .weather-box { margin-top: 8px; padding: 10px 14px; border-radius: 8px; background: var(--card); border: 1px solid var(--border); min-height: 52px; max-width: 520px; }
        .weather-label { font-size: 13px; font-weight: 900; color: var(--accent); margin-bottom: 2px; display: block; text-transform: uppercase;}
        .weather-code { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; font-size: 14px; font-weight: 700; color: var(--text); line-height: 1.4; word-break: break-all; min-height: 1.8em; white-space: pre-wrap; }
        [id^="disp-depWx-container-"], [id^="disp-arrWx-container-"] { min-height: 58px; }

        .copy-section {
            margin-top: 25px; padding: 25px; background: var(--card);
            border-radius: 20px;
            border: 5px solid transparent;
            background-image: linear-gradient(var(--card), var(--card)), var(--card-border-gradient);
            background-origin: padding-box, border-box;
            background-clip: padding-box, border-box;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            animation: slideUpFade 0.6s 0.3s ease-out forwards; opacity: 0;
            width: 100%;
            box-sizing: border-box;
            margin-left: auto;
            margin-right: auto;
        }
        .copy-section-in-card {
            margin-top: 16px;
            padding: 20px 25px;
        }
        .copy-section h3 { margin-top: 0; font-size: 16px; color: var(--primary); display: flex; align-items: center; justify-content: space-between;}
        .copy-textarea {
            width: 100%; height: 110px; resize: vertical;
            background: var(--bg); color: var(--text); border: 1px solid var(--border);
            border-radius: 10px; padding: 15px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif;
            font-size: 14px; font-weight: 700; line-height: 1.6; margin-bottom: 12px; outline: none; transition: border 0.3s;
        }
        .copy-textarea:focus { border-color: var(--accent); }
        .copy-btn {
            background: var(--accent); color: white; border: none; padding: 10px 20px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 14px;
        }
        .copy-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }

        /* å“åº”å¼å¸ƒå±€ï¼šå¹³æ¿ä¸æ‰‹æœºé€‚é… */
        @media (max-width: 1024px) {
            body {
                flex-direction: column;
                padding: 12px;
                gap: 20px;
            }
            .editor {
                width: 100%;
                max-width: 100%;
                position: static;
                height: auto;
            }
            .preview {
                width: 100%;
                max-width: 100%;
            }
            #capture-area {
                padding: 24px;
                border-radius: 24px;
            }
            .copy-zone-wrap {
                padding: 24px;
                border-radius: 24px;
            }
            .card {
                padding: 32px 24px;
                min-height: 900px;
                border-radius: 24px;
            }
            .map-wrapper {
                height: 320px;
                min-height: 320px;
            }
            .map-container {
                height: 320px;
                min-height: 320px;
            }
            .floating-controls {
                right: 12px;
            }
            .floating-controls .btn {
                min-height: 44px;
                padding: 10px 12px;
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                gap: 16px;
                -webkit-overflow-scrolling: touch;
            }
            .editor {
                padding: 16px;
            }
            #capture-area {
                padding: 16px;
                border-radius: 20px;
            }
            .copy-zone-wrap {
                padding: 16px;
                border-radius: 20px;
            }
            .card {
                padding: 24px 16px;
                min-height: 800px;
                border-radius: 20px;
            }
            .icao {
                font-size: 54px;
            }
            .cn-name {
                font-size: 16px;
            }
            .route-zone {
                padding: 12px 16px;
            }
            .route-text {
                font-size: 13px;
            }
            .proc-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 6px;
            }
            .proc-label { font-size: 11px; }
            .proc-val { font-size: 15px; }
            .meta-grid {
                flex-wrap: wrap;
                gap: 16px;
            }
            .map-wrapper {
                height: 280px;
                min-height: 280px;
            }
            .map-container {
                height: 280px;
                min-height: 280px;
            }
            .floating-controls {
                right: 50%;
                transform: translate(50%, -50%);
                padding: 10px 8px;
            }
            .floating-controls-toggle {
                display: flex;
            }
            .floating-controls.collapsed .floating-btn-group {
                display: none !important;
            }
            .floating-controls .btn {
                min-height: 44px;
                padding: 10px 12px;
                font-size: 12px;
            }
        }

        @media (max-width: 430px) {
            html { overflow-x: hidden; }
            body {
                padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(80px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
                gap: 12px;
                -webkit-overflow-scrolling: touch;
                overflow-x: hidden;
                max-width: 100vw;
            }
            .editor {
                padding: 12px;
            }
            #capture-area {
                padding: 12px;
                border-radius: 16px;
            }
            .copy-zone-wrap {
                padding: 12px;
                border-radius: 16px;
            }
            .card {
                padding: 20px 12px;
                min-height: 720px;
                border-radius: 16px;
            }
            .icao {
                font-size: 42px;
            }
            .cn-name {
                font-size: 14px;
            }
            .plane-box {
                width: 38px;
                height: 38px;
            }
            .plane-box svg {
                width: 22px;
            }
            .callsign-text {
                font-size: 16px;
            }
            .m-val-sub {
                font-size: 20px;
            }
            .route-zone {
                padding: 10px 12px;
                margin-left: 0;
                margin-right: 0;
            }
            .route-text {
                font-size: 12px;
            }
            .proc-grid {
                grid-template-columns: 1fr 1fr;
            }
            .proc-label { font-size: 10px; }
            .proc-val { font-size: 14px; }
            .gallery {
                grid-template-columns: 1fr;
            }
            .weather-box {
                max-width: 100%;
            }
            .map-wrapper {
                height: 240px;
                min-height: 240px;
            }
            .map-container {
                height: 240px;
                min-height: 240px;
            }
            .floating-controls {
                left: 12px;
                right: 12px;
                bottom: max(12px, env(safe-area-inset-bottom));
                top: auto;
                transform: none;
                display: flex;
                flex-direction: column;
                padding: 10px 8px;
            }
            .floating-controls.collapsed .floating-btn-group {
                display: none !important;
            }
            .floating-btn-group {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
                width: 100%;
            }
            .floating-controls .btn {
                min-height: 44px;
                padding: 10px 12px;
                font-size: 11px;
                min-width: calc(50% - 6px);
                flex: 1 1 auto;
            }
        }
    </style>
</head>
<body>

<div id="permanent-vault" style="display:none;"></div>

<datalist id="acft-list"></datalist>

<div class="editor">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
        <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:28px;">âœˆï¸</span>
            <h2>é£è¡Œä»»åŠ¡ç­¾æ´¾</h2>
        </div>
        <button class="mode-toggle" onclick="toggleDarkMode()" id="modeBtn">ğŸŒ™ é»‘å¤œæ¨¡å¼</button>
    </div>

    <div class="simbrief-row">
        <div class="simbrief-id-wrap">
            <img src="https://www.simbrief.com/favicon.ico" alt="SimBrief ID" class="simbrief-id-icon" title="SimBrief ID" onerror="this.outerHTML='<span class=\'simbrief-id-fallback\'>ID</span>'">
        </div>
        <input type="text" id="simbrief-pilot-id" placeholder="" class="simbrief-id-input" />
        <button class="sb-btn sb-btn-api" onclick="fetchSimBriefFromAPI()">API è·å–</button>
    </div>
    <div class="sb-import-area">
        <label>âš¡ SimBrief è§£æ</label>
        <textarea id="sb-raw-text" rows="2"></textarea>
        <div class="sb-btn-row">
            <button class="sb-btn" onclick="parseSimBrief()">ç›´æ¥è§£æ</button>
        </div>
    </div>

    <div id="editorStack"></div>
</div>

<div class="preview">
    <div id="capture-area">
        <div id="previewZone"></div>
    </div>
    <div class="copy-zone-wrap">
        <div id="copy-zone"></div>
    </div>
</div>

<!-- å³ä¸‹è§’æ‚¬æµ®æ“ä½œæ¡ -->
<div class="floating-controls collapsed" id="floating-controls">
    <button type="button" class="floating-controls-toggle" id="floating-controls-toggle" onclick="toggleFloatingControls()" aria-label="å±•å¼€/æ”¶èµ·å·¥å…·">å·¥å…·</button>
    <div class="btn-group floating-btn-group">
        <button class="btn add-btn" onclick="addNewLeg()">å¢åŠ èˆªæ®µ</button>
        <button class="btn reset-btn" onclick="resetAllMaps()">å±…ä¸­èˆªçº¿</button>
        <button class="btn reset-btn" id="mapExportToggleBtn_floating" onclick="toggleExportMapMode()">å«åœ°å›¾å¯¼å‡º</button>
        <button class="btn export-btn" onclick="exportAsImage()">ä¿å­˜å›¾ç‰‡</button>
        <button class="btn html-btn" onclick="exportAsHTML()">ç”Ÿæˆç½‘é¡µ</button>
        <button type="button" class="btn sb-btn" style="background:#64748b; font-size:10px;" onclick="showLastSimBriefJson()" title="å°†ä¸Šæ¬¡ API è¿”å›çš„ JSON æ˜¾ç¤ºåœ¨æ–‡æœ¬æ¡†">æŸ¥çœ‹ JSON</button>
    </div>
</div>

<script>
let airportGeoData = {};
let mapInstances = {}; 
let mapDoms = {}; 
let routeLayers = {}; 
let altLayers = {};
let altMarkers = {}; // å¤‡é™ç‚¹ markerï¼Œç”¨äºä»…æ›´æ–°å¤‡é™æ—¶ç§»é™¤
let overlayGroups = {}; // å åŠ å›¾å±‚ç»„ï¼Œèµ·é™å˜åŒ–æ—¶åªæ¸…ç©ºæ­¤ç»„é‡ç»˜ï¼Œä¸é”€æ¯åœ°å›¾
let lastLegICAO = {}; 
let exportWithoutMap = false; // æ˜¯å¦åœ¨å¯¼å‡ºæ—¶éšè—åœ°å›¾ï¼Œä»…ä¿ç•™è®¡åˆ’ä¸èˆªè·¯

function toggleFloatingControls() {
    var el = document.getElementById('floating-controls');
    var btn = document.getElementById('floating-controls-toggle');
    if (!el || !btn) return;
    el.classList.toggle('collapsed');
    btn.textContent = el.classList.contains('collapsed') ? 'å·¥å…·' : 'æ”¶èµ·';
}
function syncMapExportToggleLabels() {
    const mainBtn = document.getElementById('mapExportToggleBtn');
    const floatBtn = document.getElementById('mapExportToggleBtn_floating');
    const text = exportWithoutMap ? 'ä»…è®¡åˆ’+èˆªè·¯' : 'å«åœ°å›¾å¯¼å‡º';
    if (mainBtn) mainBtn.innerText = text;
    if (floatBtn) floatBtn.innerText = text;
}

function initAircraftList() {
    const list = document.getElementById('acft-list');
    if (!list) return;
    list.innerHTML = '';
    const db = window.AIRCRAFT_DB || window.ACFT_DB || [];
    db.forEach(function(code) {
        const opt = document.createElement('option');
        opt.value = typeof code === 'string' ? code : (code.id || code.name || String(code));
        list.appendChild(opt);
    });
}

let flightData = [{ call: '', acft: '', dist: '', crz: '', dep: '', depN: '', depRwy: '', sid: '', depTrans: '', arr: '', arrN: '', arrTrans: '', star: '', arrRwy: '', alt: '', altN: '', rte: '', imgs: [], depWx: '', arrWx: '' }];

fetch('https://cdn.jsdelivr.net/gh/mwgg/Airports@master/airports.json')
    .then(res => res.json())
    .then(data => {
        airportGeoData = data;
        for (let icao in data) { 
            if (typeof DB !== 'undefined' && !DB[icao] && icao.length === 4) { 
                DB[icao] = data[icao].city || data[icao].name; 
            } 
        }
        draw();
    });

function applyRandomCardBorderGradient() {
    const gradients = [
        'linear-gradient(90deg, rgba(37,99,235,0.45), rgba(16,185,129,0.45))',
        'linear-gradient(90deg, rgba(245,158,11,0.5), rgba(239,68,68,0.45))',
        'linear-gradient(90deg, rgba(56,189,248,0.5), rgba(129,140,248,0.5))',
        'linear-gradient(90deg, rgba(236,72,153,0.5), rgba(34,211,238,0.45))',
        'linear-gradient(90deg, rgba(22,163,74,0.5), rgba(190,242,100,0.45))',
        'linear-gradient(90deg, rgba(148,163,184,0.6), rgba(30,64,175,0.6))'
    ];
    const pick = gradients[Math.floor(Math.random() * gradients.length)];
    document.documentElement.style.setProperty('--card-border-gradient', pick);
}

window.onload = () => { 
    applyRandomCardBorderGradient();
    initAircraftList();
    var pilotIdEl = document.getElementById('simbrief-pilot-id');
    if (pilotIdEl && localStorage.getItem('simbrief_pilot_id')) pilotIdEl.value = localStorage.getItem('simbrief_pilot_id');
    if (pilotIdEl) pilotIdEl.addEventListener('change', function() { localStorage.setItem('simbrief_pilot_id', this.value.trim()); });
    renderEditor(); 
    draw(); 
};

/** ä» SimBrief API è·å–æœ€æ–°è®¡åˆ’å¹¶å¡«å…¥ flightData[0]ã€‚æ”¯æŒ Pilot IDï¼ˆæ•°å­—ï¼‰æˆ–ç”¨æˆ·åï¼Œå­˜äº localStorageã€‚ */
async function fetchSimBriefFromAPI() {
    var pilotIdEl = document.getElementById('simbrief-pilot-id');
    var pilotId = (pilotIdEl && pilotIdEl.value.trim()) || (typeof localStorage !== 'undefined' && localStorage.getItem('simbrief_pilot_id')) || '';
    if (!pilotId) {
        alert('è¯·å…ˆè¾“å…¥ SimBrief Pilot IDï¼ˆæ•°å­—ï¼‰æˆ–ç”¨æˆ·åï¼Œå¹¶ç¡®ä¿å·²åœ¨ simbrief.com ç”Ÿæˆè¿‡è‡³å°‘ä¸€æ¬¡é£è¡Œè®¡åˆ’ã€‚');
        if (pilotIdEl) pilotIdEl.focus();
        return;
    }
    if (pilotIdEl) { pilotIdEl.value = pilotId; localStorage.setItem('simbrief_pilot_id', pilotId); }
    var base = 'https://www.simbrief.com/api/xml.fetcher.php';
    var urlByUserid = base + '?userid=' + encodeURIComponent(pilotId) + '&json=1';
    var urlByUsername = base + '?username=' + encodeURIComponent(pilotId) + '&json=1';
    var btn = document.querySelector('.sb-btn-api');
    var origText = btn ? btn.innerText : '';
    if (btn) { btn.innerText = 'è·å–ä¸­â€¦'; btn.disabled = true; }
    var data, res, triedUsername = false;

    function doFetch(url) { return fetch(url, { method: 'GET', mode: 'cors' }); }
    function applyAndUpdate() {
        applySimBriefJsonToFlightData(data);
        if (typeof renderEditor === 'function') renderEditor();
        if (typeof draw === 'function') draw();
        if (flightData[0].dep && flightData[0].arr && typeof initMapForLeg === 'function') initMapForLeg(0);
    }

    try {
        res = await doFetch(urlByUserid);
        if (!res.ok && res.status === 400) {
            triedUsername = true;
            res = await doFetch(urlByUsername);
        }
        if (!res.ok) {
            var errBody = '';
            try { errBody = await res.text(); } catch (_) {}
            if (res.status === 400) {
                alert('SimBrief è¿”å›ï¼šID/ç”¨æˆ·åæ— æ•ˆæˆ–è¯¥è´¦å·æš‚æ— é£è¡Œè®¡åˆ’ã€‚\n\nè¯·ç¡®è®¤ï¼š\n1) è¾“å…¥çš„æ˜¯æ•°å­— Pilot IDï¼Œæˆ– SimBrief ç™»å½•ç”¨æˆ·åï¼›\n2) å·²åœ¨ simbrief.com ç”Ÿæˆè¿‡è‡³å°‘ä¸€æ¬¡ OFPã€‚\n\nPilot ID å¯åœ¨ SimBrief è´¦æˆ·è®¾ç½®æˆ–ã€Œæ–°é£è¡Œã€å¯é€‰æ¡ç›®ä¸­æŸ¥çœ‹ã€‚' + (errBody ? '\n\næ¥å£è¿”å›: ' + errBody.slice(0, 200) : ''));
            } else {
                alert('è¯·æ±‚å¤±è´¥: HTTP ' + res.status + (errBody ? '\n' + errBody.slice(0, 150) : ''));
            }
            return;
        }
        data = await res.json();
        window._lastSimBriefJson = data;
        if (typeof console !== 'undefined' && console.log) console.log('SimBrief è¿”å›çš„ JSON å·²å­˜å…¥ window._lastSimBriefJsonï¼Œå¯åœ¨æ§åˆ¶å°è¾“å…¥ï¼š\nJSON.stringify(window._lastSimBriefJson, null, 2)');
        applyAndUpdate();
    } catch (e) {
        if ((e.message && e.message.indexOf('Failed to fetch') !== -1) || e.name === 'TypeError') {
            try {
                var proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(triedUsername ? urlByUsername : urlByUserid);
                res = await fetch(proxyUrl);
                if (!res.ok) {
                    if (res.status === 400 && !triedUsername) {
                        proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(urlByUsername);
                        res = await fetch(proxyUrl);
                        triedUsername = true;
                    }
                }
                if (!res.ok) {
                    alert('ä»£ç†è¯·æ±‚å¤±è´¥æˆ– SimBrief è¿”å› 400ï¼šè¯·æ£€æŸ¥ Pilot ID/ç”¨æˆ·åï¼Œå¹¶ç¡®ä¿å·²ç”Ÿæˆè¿‡é£è¡Œè®¡åˆ’ã€‚');
                    return;
                }
                data = await res.json();
                window._lastSimBriefJson = data;
                if (typeof console !== 'undefined' && console.log) console.log('SimBrief è¿”å›çš„ JSON å·²å­˜å…¥ window._lastSimBriefJson');
                applyAndUpdate();
            } catch (e2) {
                alert('è·å–å¤±è´¥ï¼ˆå¯èƒ½å› è·¨åŸŸ CORSï¼‰ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚\n' + (e2.message || e2));
            }
        } else {
            alert('è·å–å¤±è´¥: ' + (e.message || e));
        }
    } finally {
        if (btn) { btn.innerText = origText; btn.disabled = false; }
    }
}

/** å°†ä¸Šæ¬¡ API è·å–çš„ JSON æ ¼å¼åŒ–åæ˜¾ç¤ºåœ¨æ–‡æœ¬æ¡†ï¼Œä¾¿äºæŸ¥çœ‹ç»“æ„ã€‚ */
function showLastSimBriefJson() {
    var ta = document.getElementById('sb-raw-text');
    if (typeof window._lastSimBriefJson === 'undefined' || window._lastSimBriefJson === null) {
        alert('è¯·å…ˆç‚¹å‡»ã€ŒAPI è·å–ã€æˆåŠŸæ‹‰å–ä¸€æ¬¡è®¡åˆ’ï¼Œå†ç‚¹ã€ŒæŸ¥çœ‹ JSONã€ã€‚');
        return;
    }
    try {
        var str = JSON.stringify(window._lastSimBriefJson, null, 2);
        if (ta) { ta.value = str; ta.rows = Math.min(30, Math.max(10, str.split('\n').length)); }
    } catch (e) {
        alert('JSON åºåˆ—åŒ–å¤±è´¥: ' + (e.message || e));
    }
}

/** ä»å•ä¸ªå¯¹è±¡ä¸­å–ç¬¬ä¸€ä¸ªå­˜åœ¨çš„é”®å€¼ã€‚ç”¨æ³•: firstVal(obj, 'key1', 'key2', ...) */
function firstVal(obj) {
    if (!obj || typeof obj !== 'object') return '';
    for (var i = 1; i < arguments.length; i++) {
        var v = obj[arguments[i]];
        if (v !== undefined && v !== null && v !== '') return v;
    }
    return '';
}

/** å°† SimBrief API è¿”å›çš„ JSON å†™å…¥ flightData[0]ï¼Œé«˜åº¦å±‚ 5 ä½è‹±å°ºè½¬ 3 ä½ FLã€‚ */
function applySimBriefJsonToFlightData(data) {
    if (!data || !flightData.length) return;
    var d = flightData[0];
    var p = data.params || data;
    var gen = data.general || p.general || p || {};
    var o = data.origin || p.origin;
    var dest = data.destination || p.destination || data.dest || p.dest;
    var alt = data.alternate || data.alternates || p.alternate;
    var acft = data.aircraft || p.aircraft || {};
    var dep = data.departure || data.dep || p.departure || {};
    var arr = data.arrival || data.arr || p.arrival || {};
    var wx = data.weather || p.weather || p;

    if (typeof o === 'string') { d.dep = o.toUpperCase().slice(0, 4); d.depN = ''; } else if (o && typeof o === 'object') {
        d.dep = (o.icao_code || o.icao || o.id || '').toString().toUpperCase().slice(0, 4);
        d.depN = (o.name || o.airport_name || '').toString().trim();
    } else {
        d.dep = (p.orig || gen.origin || '').toString().toUpperCase().slice(0, 4);
        d.depN = '';
    }
    if (typeof dest === 'string') { d.arr = dest.toUpperCase().slice(0, 4); d.arrN = ''; } else if (dest && typeof dest === 'object') {
        d.arr = (dest.icao_code || dest.icao || dest.id || '').toString().toUpperCase().slice(0, 4);
        d.arrN = (dest.name || dest.airport_name || '').toString().trim();
    } else {
        d.arr = (p.dest || gen.destination || '').toString().toUpperCase().slice(0, 4);
        d.arrN = '';
    }

    var callStr = (p.callsign || data.callsign || gen.callsign || '').toString().trim();
    if (!callStr && (gen.icao_airline != null || gen.flight_number != null)) {
        callStr = [gen.icao_airline, gen.flight_number].filter(Boolean).join('').trim();
    }
    if (callStr) d.call = callStr;

    d.acft = (acft.icaocode || acft.type || p.type || gen.aircraft_type || p.aircraft_type || '').toString().trim();

    if (alt) {
        var altIcao = Array.isArray(alt) ? (alt[0] && (alt[0].icao_code || alt[0].icao || alt[0])) : (alt.icao_code || alt.icao || (typeof alt === 'string' ? alt : ''));
        d.alt = (altIcao || '').toString().toUpperCase().slice(0, 4);
        d.altN = Array.isArray(alt) && alt[0] ? (alt[0].name || '') : (alt.name || '');
    }

    d.depRwy = (o && typeof o === 'object' && o.plan_rwy) || (dep.runway || dep.dep_runway || dep.departure_runway || p.orig_rwy || p.origrwy || gen.orig_rwy || '').toString().trim().replace(/^RW/i, '');
    d.arrRwy = (dest && typeof dest === 'object' && dest.plan_rwy) || (arr.runway || arr.arr_runway || arr.arrival_runway || p.dest_rwy || p.destrwy || gen.dest_rwy || '').toString().trim().replace(/^RW/i, '');

    var distStr = (gen.route_distance || gen.gc_distance || gen.air_distance || gen.distance || p.gnd_dist || p.route_distance || data.distance || '').toString();
    var distNum = distStr.replace(/\D/g, '');
    if (distNum) d.dist = distNum.slice(0, 6);

    var crzFt = parseInt(firstVal(gen, 'initial_altitude', 'cruise_altitude', 'altitude') || firstVal(p, 'initial_altitude', 'cruise_altitude') || firstVal(data, 'cruise_altitude', 'initial_altitude') || 0, 10);
    if (crzFt > 0) {
        if (crzFt < 1000) crzFt = crzFt * 100;
        var fl = Math.min(999, Math.round(crzFt / 100));
        d.crz = fl.toString().slice(0, 3);
    }

    var atcRoute = data.atc && (data.atc.route || data.atc.route_ifps);
    var routeStr = (atcRoute || gen.route_ifps || gen.route_navigraph || gen.route || gen.filed_route || p.route || p.filed_route || data.route || '').toString().trim();
    if (!routeStr && data.navlog && Array.isArray(data.navlog.fix)) {
        routeStr = data.navlog.fix.map(function(f) { return f.ident || f.name || ''; }).filter(Boolean).join(' ');
    }
    d.sid = (gen.sid_ident || '').toString().trim() || d.sid;
    d.star = (gen.star_ident || '').toString().trim() || d.star;
    d.depTrans = (gen.sid_trans && typeof gen.sid_trans === 'string' ? gen.sid_trans : (gen.sid_trans && typeof gen.sid_trans === 'object' && gen.sid_trans.value != null ? gen.sid_trans.value : '')).toString().trim() || d.depTrans;
    if (routeStr) {
        var parts = routeStr.split(/\s+/).filter(Boolean);
        if (parts[0] && parts[0].indexOf('/') !== -1) { d.depRwy = d.depRwy || parts[0].split('/')[1].replace(/^RW/i, '').replace(/\..*$/i, '').trim() || ''; parts.shift(); }
        if (parts[parts.length - 1] && parts[parts.length - 1].indexOf('/') !== -1) {
            var arrPart = parts.pop();
            var rwyMatch = arrPart.match(/\/([A-Z0-9]+)$/i) || arrPart.match(/\.[A-Z]*\.?([A-Z0-9]+)$/i);
            if (rwyMatch) d.arrRwy = d.arrRwy || rwyMatch[1].replace(/^RW/i, '');
        }
        // è·³è¿‡èˆªè·¯å¼€å¤´çš„é€Ÿåº¦/é«˜åº¦çº¦æŸï¼ˆå¦‚ N0427F340ã€M082ï¼‰å’Œ DCTï¼Œå†è¯†åˆ« SID / ç¦»åœºè¿‡æ¸¡
        var start = 0;
        while (start < parts.length && (
            /^N\d+F\d+$/i.test(parts[start]) ||
            /^M\d+/i.test(parts[start]) ||
            /^DCT$/i.test(parts[start]) ||
            /^\d{4,5}$/.test(parts[start])
        )) start++;
        if (!d.sid && start < parts.length && /^[A-Z0-9]{2,8}$/i.test(parts[start])) d.sid = parts[start];
        if (!d.depTrans && start + 1 < parts.length && /^[A-Z0-9]{2,6}$/i.test(parts[start + 1]) && !/^[A-Z]\d{3}$/i.test(parts[start + 1])) d.depTrans = parts[start + 1];
        if (!d.star && parts.length > 0 && /^[A-Z0-9]{2,8}$/i.test(parts[parts.length - 1])) d.star = parts[parts.length - 1];
        d.rte = parts.join(' ').replace(/\s*\/\s*/, ' ').trim();
    }

    d.depWx = (wx.orig_metar || wx.origin_metar || (wx.origin && wx.origin.metar) || data.orig_metar || p.orig_metar || '').toString().trim();
    d.arrWx = (wx.dest_metar || wx.destination_metar || (wx.destination && wx.destination.metar) || data.dest_metar || p.dest_metar || '').toString().trim();

    if (typeof DB !== 'undefined') {
        if (d.dep && DB[d.dep]) d.depN = DB[d.dep];
        if (d.arr && DB[d.arr]) d.arrN = DB[d.arr];
        if (d.alt && DB[d.alt]) d.altN = DB[d.alt];
    }
}

function parseSimBrief(sourceText) {
    const raw = sourceText || document.getElementById('sb-raw-text').value;
    if (!raw) return alert("è¯·å…ˆç²˜è´´ SimBrief æ–‡æœ¬å†…å®¹ï¼");
    let idx = flightData.length - 1;
    
    const callMatch = raw.match(/ATC\s+C\/S\s+([A-Z0-9]+)/i) || raw.match(/CALLSIGN[:\s]+([A-Z0-9]+)/i) || raw.match(/OFP\s+FOR\s+([A-Z0-9]+)/i);
    if (callMatch) flightData[idx].call = callMatch[1].trim();
    
    // æœºå‹ï¼šåªåœ¨ OFP å¤´éƒ¨åŒ¹é…ï¼Œé¿å…åæ–‡ "AIRCRAFT FLYING" ç­‰è¯¯åŒ¹é…ä¸ºæœºå‹
    const head = raw.slice(0, 3200);
    const acftMatch = head.match(/FENIX\s+([A-Z]\d{3}(?:-\d+)?)\s*(?:\/|$)/i)
        || head.match(/[A-Z]{4}\s*[-â€“]\s*[A-Z]{4}\s{2,}([A-Z]\d{3}(?:-\d+)?)\s/i)
        || head.match(/(?:AIRCRAFT|ACFT)[:\s]+(A\d{3}(?:-\d+)?|B\d{3}(?:-\d+)?|B77[0-9]|B78[0-9]|C\d{3}|MD\d{2}|E\d{3})\b/i)
        || raw.match(/\s(A\d{3}|B\d{3}(?:-\d+)?|B77[0-9]|B78[0-9]|C\d{3}|MD\d{2}|E\d{3})\s/i);
    if (acftMatch) flightData[idx].acft = acftMatch[1].trim();
    
    let depArrMatch = raw.match(/([A-Z]{4})\s*\/\s*[A-Z]{3}\s+([A-Z]{4})\s*\/\s*[A-Z]{3}/);
    if (!depArrMatch) depArrMatch = raw.match(/FROM\s+([A-Z]{4})\s+TO\s+([A-Z]{4})/i) || raw.match(/ORIGIN[:\s]+([A-Z]{4})[\s\S]+?DEST(?:INATION)?[:\s]+([A-Z]{4})/i);
    if (depArrMatch) { 
        flightData[idx].dep = depArrMatch[1]; 
        flightData[idx].depN = (typeof DB !== 'undefined' && DB[depArrMatch[1]]) || ""; 
        flightData[idx].arr = depArrMatch[2]; 
        flightData[idx].arrN = (typeof DB !== 'undefined' && DB[depArrMatch[2]]) || ""; 
    }
    
    const altMatch = raw.match(/ALTN(?:ATE)?\s*[:\s]+\s*([A-Z]{4})/i) || raw.match(/ALTN\s+([A-Z]{4})/i) || raw.match(/ALTERNATE[:\s]+([A-Z]{4})/i);
    if (altMatch) { flightData[idx].alt = altMatch[1]; flightData[idx].altN = (typeof DB !== 'undefined' && DB[altMatch[1]]) || ""; }
    
    const distMatch = raw.match(/(?:GND|TRIP|GC|AIR)\s+DIST(?:ANCE)?:?\s*(\d+)/i) || raw.match(/DIST(?:ANCE)?:\s*(\d+)/i) || raw.match(/(\d+)\s*NM\s+(?:total|distance)/i);
    if (distMatch) flightData[idx].dist = distMatch[1];

    // âœ¨ æ·±åº¦ä¼˜åŒ–ï¼šæ™ºèƒ½è¯†åˆ«å…¬åˆ¶é«˜åº¦å¹¶è½¬æ¢ä¸º3ä½è‹±å°º FL
    const flStepsMatch = raw.match(/FL\s+STEPS\s+([A-Z0-9\/]+)/i);
    let maxFL = 0;

    if (flStepsMatch) {
        const stepsParts = flStepsMatch[1].split('/');
        stepsParts.forEach(part => {
            if (/^\d{3,5}$/.test(part)) {
                let val = parseInt(part, 10);
                // å¦‚æœæ˜¯ 4 ä½æ•°å­—ï¼ˆå¦‚ 0840ã€1020ï¼‰ï¼ŒSimBrief é€šå¸¸è¡¨ç¤ºâ€œç™¾ç±³é«˜åº¦ç­‰çº§â€ï¼ˆ0840 => 8400mï¼‰
                if (part.length === 4 && val > 600 && val < 1400) { 
                        const meters = val * 10;          // 0840 -> 8400m
                        const feet = meters * 3.28084;    // è½¬è‹±å°º
                        val = Math.round(feet / 100);     // è‹±å°ºè½¬ FLï¼ˆç™¾è‹±å°ºï¼‰
                } else if (part.length === 5) {
                        val = Math.round(val / 100);      // 5ä½è‹±å°ºé«˜åº¦ï¼ˆå¦‚ 35000ï¼‰è½¬ FL
                }
                if (val > maxFL) maxFL = val;
            }
        });
    } else {
        // æ•è·å¯é€‰çš„ Mï¼ˆç±³ï¼‰å•ä½ï¼Œå¦‚æœæ˜¯ç±³ï¼Œåˆ™å…ˆè½¬è‹±å°ºå†è½¬ FL
        const crzMatch = raw.match(/(?:INITIAL\s+CRZ|CRZ\s+SYS|CRZ\s+ALT|CRZ|LVL):?\s*(?:FL)?(\d{2,5})(M?)/i);
        if (crzMatch) {
            let val = parseInt(crzMatch[1], 10);
            const isMeters = crzMatch[2] && crzMatch[2].toUpperCase() === 'M';

            if (isMeters) {
                // ä¾‹å¦‚ 10630M -> çº¦ 34868ft -> FL349
                const meters = val;
                const feet = meters * 3.28084;
                val = Math.round(feet / 100); // è½¬æˆä»¥ç™¾è‹±å°ºä¸ºå•ä½çš„ FL
            } else if (crzMatch[1].length === 5) {
                // 5 ä½çº¯æ•°å­—ï¼Œè§†ä¸ºè‹±å°ºé«˜åº¦ï¼ˆå¦‚ 35000ï¼‰ï¼Œè½¬ä¸º FL
                val = Math.round(val / 100);
            }
            maxFL = val;
        }
    }
    if (maxFL > 0) {
        // ç»Ÿä¸€å¤„ç†ä¸º 3 ä½ FLï¼ˆæœ€å¤š 999ï¼‰ï¼Œå¤šä½™ä½æ•°æˆªæ–­
        let flVal = Math.min(maxFL, 999);
        let flStr = flVal.toString();
        if (flStr.length > 3) flStr = flStr.slice(0, 3);
        flightData[idx].crz = flStr;
    }

    const routeBlock = raw.match(/ROUTE ID:[\s\S]+?\n([\s\S]+?)(?:\n\n|\n-)/i) || raw.match(/ROUTING:[\s\S]+?\n([\s\S]+?)(?:\n\n|$)/i) || raw.match(/FULL ROUTE:?\s*\n([\s\S]+?)(?:\n\n|$)/i);
    if (routeBlock) {
        let fullRte = routeBlock[1].replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
        let parts = fullRte.split(/\s+/).filter(Boolean);
        if (parts[0] && parts[0].includes('/')) { flightData[idx].depRwy = parts[0].split('/')[1]; parts.shift(); }
        var start = 0;
        while (start < parts.length && (
            /^N\d+F\d+$/i.test(parts[start]) || /^M\d+/i.test(parts[start]) || /^DCT$/i.test(parts[start]) || /^\d{4,5}$/.test(parts[start])
        )) start++;
        if (start < parts.length) flightData[idx].sid = parts[start];
        if (start + 1 < parts.length && /^[A-Z0-9]{2,6}$/i.test(parts[start + 1]) && !/^[A-Z]\d{3}$/i.test(parts[start + 1])) flightData[idx].depTrans = parts[start + 1];
        let lastPart = parts[parts.length - 1];
        if (lastPart && lastPart.includes('/')) flightData[idx].arrRwy = lastPart.split('/')[1];
        if (parts.length > 3) { let starCandidate = parts[parts.length - 2] === 'DCT' ? parts[parts.length - 3] : parts[parts.length - 2]; flightData[idx].star = starCandidate; }
        flightData[idx].rte = parts.slice(start, parts.length - 1).join(' ').trim();
    }
    
    const depWxMatch = raw.match(/Departure:[\s\S]+?SA\s+([\d]{6}\s+[\s\S]+?)(?=\n)/i) || raw.match(/DEPARTURE[\s\S]+?METAR[:\s]*([A-Z0-9\s]+(?=\n|$))/i);
    if (depWxMatch) flightData[idx].depWx = depWxMatch[1].trim();
    
    const arrWxMatch = raw.match(/Destination:[\s\S]+?SA\s+([\d]{6}\s+[\s\S]+?)(?=\n)/i) || raw.match(/DEST(?:INATION)?[\s\S]+?METAR[:\s]*([A-Z0-9\s]+(?=\n|$))/i);
    if (arrWxMatch) flightData[idx].arrWx = arrWxMatch[1].trim();
    
    renderEditor(); draw(); 
}

function toggleDarkMode() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
    document.getElementById('modeBtn').innerText = isDark ? 'ğŸŒ™ é»‘å¤œæ¨¡å¼' : 'â˜€ï¸ ç™½å¤©æ¨¡å¼';
    Object.values(mapInstances).forEach(m => m.invalidateSize());
}

function resetAllMaps() {
    Object.keys(mapInstances).forEach(idx => {
        const map = mapInstances[idx];
        const layer = routeLayers[idx];
        const altLayer = altLayers[idx];
        if (map && layer) {
            map.invalidateSize();
            let bounds = layer.getBounds();
            if (altLayer) bounds = bounds.extend(altLayer.getBounds());
            map.fitBounds(bounds, { padding: [100, 100], animate: true });
        }
    });
}

function toggleExportMapMode() {
    exportWithoutMap = !exportWithoutMap;
    syncMapExportToggleLabels();
}

function toggleFloatingPanel(event) {
    const container = document.querySelector('.floating-controls');
    if (!container) return;
    // é¿å…å†…éƒ¨æŒ‰é’®ç‚¹å‡»å†æ¬¡è§¦å‘å±•å¼€/æŠ˜å é€»è¾‘
    if (event && event.target && event.target.tagName === 'BUTTON') return;
    const isCollapsed = container.classList.contains('fc-collapsed');
    if (isCollapsed) {
        container.classList.remove('fc-collapsed');
        container.classList.add('fc-expanded');
    } else {
        container.classList.remove('fc-expanded');
        container.classList.add('fc-collapsed');
    }
}

function updateCopyText(idx) {
    let leg = flightData[idx];
    let fullRoute = [leg.dep + (leg.depRwy ? '/' + leg.depRwy : ''), leg.rte, leg.arr + (leg.arrRwy ? '/' + leg.arrRwy : '')].filter(Boolean).join(' ').trim();
    let copyArea = document.getElementById(`copy-text-area-${idx}`);
    if (copyArea) copyArea.value = fullRoute;
}

async function fetchMetar(idx, type) {
    const icao = type === 'dep' ? flightData[idx].dep : flightData[idx].arr;
    if (!icao || icao.length < 4) return alert("è¯·è¾“å…¥æœºåœº ICAO");
    const btn = event.target; btn.innerText = "...";
    try {
        const response = await fetch(`https://metar.vatsim.net/metar.php?id=${icao.toUpperCase()}`);
        const data = await response.text();
        if (data && data.length > 5) { 
            flightData[idx][type + 'Wx'] = data.trim(); 
            let container = document.getElementById(`disp-${type}Wx-container-${idx}`);
            if(container) container.innerHTML = `<div class="weather-box"><span class="weather-label">${type === 'dep'?'DEPARTURE':'ARRIVAL'} METAR (${icao})</span><div class="weather-code">${data.trim()}</div></div>`;
            updateCopyText(idx);
        }
    } catch (e) { alert("ç½‘ç»œé”™è¯¯"); } finally { btn.innerText = type === 'dep' ? "èµ·é£å¤©æ°”" : "åˆ°è¾¾å¤©æ°”"; }
}

function deleteWx(idx, type) { 
    flightData[idx][type + 'Wx'] = ''; 
    let container = document.getElementById(`disp-${type}Wx-container-${idx}`);
    if(container) container.innerHTML = '';
    updateCopyText(idx);
}

function exportAsImage() {
    const target = document.getElementById('capture-area');
    const btn = document.querySelector('.export-btn');
    const originalBtnText = btn.innerText;
    btn.innerText = "å‡†å¤‡èˆªå›¾åŠ è½½..."; btn.disabled = true;
    
    window.scrollTo(0, 0);

    target.classList.add('no-animation');
    if (exportWithoutMap) target.classList.add('no-map');
    target.classList.add('capture-no-border');
    target.offsetHeight; 

    if (!exportWithoutMap) {
        Object.keys(mapInstances).forEach(idx => {
            const map = mapInstances[idx];
            const layer = routeLayers[idx];
            const altLayer = altLayers[idx];
            if (map && layer) {
                map.invalidateSize();
                let b = layer.getBounds();
                if (altLayer) b = b.extend(altLayer.getBounds());
                map.fitBounds(b, { padding: [80, 80], animate: false });
            }
        });
    }

    const delay = exportWithoutMap ? 400 : 1500;
    setTimeout(() => {
        btn.innerText = "ç”Ÿæˆé«˜æ¸…å›¾ç‰‡ä¸­...";
        html2canvas(target, { 
            useCORS: true, 
            allowTaint: false, 
            scale: 3, 
            backgroundColor: null,
            logging: false
        }).then(canvas => {
            const link = document.createElement('a'); 
            link.download = `Dispatch_${flightData[0].call || 'Plan'}.png`;
            link.href = canvas.toDataURL("image/png"); 
            link.click();
        }).catch(err => {
            console.error(err);
            alert("æˆªå›¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
        }).finally(() => {
            target.classList.remove('no-animation');
            target.classList.remove('no-map');
            target.classList.remove('capture-no-border');
            btn.innerText = originalBtnText; btn.disabled = false;
        });
    }, delay); 
}

function exportAsHTML() {
    const target = document.getElementById('capture-area');
    const btn = document.querySelector('.html-btn');
    const originalBtnText = btn.innerText;
    btn.innerText = "å‡†å¤‡èˆªå›¾åŠ è½½..."; btn.disabled = true;
    
    window.scrollTo(0, 0);

    target.classList.add('no-animation');
    if (exportWithoutMap) target.classList.add('no-map');
    target.classList.add('capture-no-border');
    target.offsetHeight; 

    if (!exportWithoutMap) {
        Object.keys(mapInstances).forEach(idx => {
            const map = mapInstances[idx];
            const layer = routeLayers[idx];
            const altLayer = altLayers[idx];
            if (map && layer) {
                map.invalidateSize();
                let b = layer.getBounds();
                if (altLayer) b = b.extend(altLayer.getBounds());
                map.fitBounds(b, { padding: [80, 80], animate: false });
            }
        });
    }

    const htmlDelay = exportWithoutMap ? 400 : 1500;
    setTimeout(() => {
        btn.innerText = "æ­£åœ¨æ‰“åŒ…ç½‘é¡µ...";
        html2canvas(target, { 
            useCORS: true, 
            allowTaint: false, 
            scale: 3, 
            backgroundColor: null,
            logging: false
        }).then(canvas => {
            const imgData = canvas.toDataURL("image/png");

            let cleanRouteText = "";
            flightData.forEach((leg, i) => {
                if (flightData.length > 1) cleanRouteText += `--- èˆªæ®µ ${i + 1} ---\n`;
                let routeStr = [leg.dep + (leg.depRwy ? '/' + leg.depRwy : ''), leg.rte, leg.arr + (leg.arrRwy ? '/' + leg.arrRwy : '')].filter(Boolean).join(' ').trim();
                if (routeStr) {
                    cleanRouteText += routeStr + "\n\n";
                }
            });
            cleanRouteText = cleanRouteText.trim();

            const htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è¡Œç®€æŠ¥ - ${flightData[0].call || 'Plan'}</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; 
            background: #f1f5f9; color: #1e293b; margin: 0; padding: 40px 20px; 
            display: flex; flex-direction: column; align-items: center; 
        }
        .container { 
            max-width: 900px; width: 100%; display: flex; flex-direction: column; gap: 30px; 
        }
        .image-box { 
            background: #cbd5e1; border-radius: 30px; padding: 40px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; 
        }
        .image-box img { 
            max-width: 100%; height: auto; display: block; margin: 0 auto; 
            border-radius: 10px; 
        }
        .text-box { 
            background: #ffffff; border-radius: 20px; padding: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid #cbd5e1;
        }
        .text-box .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; 
        }
        .text-box .header h3 { 
            margin: 0; color: #0f172a; font-size: 18px; display: flex; align-items: center; gap: 8px;
        }
        .copy-btn { 
            background: #2563eb; color: #fff; border: none; padding: 10px 20px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; 
        }
        .copy-btn:hover { background: #1d4ed8; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(37,99,235,0.3); }
        .text-box textarea { 
            width: 100%; height: 160px; resize: vertical; padding: 15px; box-sizing: border-box; 
            border: 2px dashed #cbd5e1; border-radius: 12px; background: #f8fafc; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif;
            font-size: 14px; font-weight: 700; color: #334155; outline: none; line-height: 1.6; transition: border 0.3s;
        }
        .text-box textarea:focus { border-color: #2563eb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="image-box">
            <img src="${imgData}" alt="Flight Dispatch Board">
        </div>
        <div class="text-box">
            <div class="header">
                <h3>ENROUTE BRIEFING</h3>
                <button class="copy-btn" onclick="copyRouteText(this)">ä¸€é”®å¤åˆ¶</button>
            </div>
            <textarea id="route-text" readonly>${cleanRouteText}</textarea>
        </div>
    </div>

    <script>
        function copyRouteText(btn) {
            const ta = document.getElementById('route-text');
            ta.select();
            ta.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(ta.value).then(() => {
                const originalText = btn.innerText;
                btn.innerText = "âœ… å¤åˆ¶æˆåŠŸ";
                btn.style.background = "#059669";
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.background = "";
                }, 2000);
            });
        }
    <\/script>
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `FlightBriefing_${flightData[0].call || 'Plan'}.html`;
            link.click();

        }).catch(err => {
            console.error(err);
            alert("ç½‘é¡µæ‰“åŒ…å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
        }).finally(() => {
            target.classList.remove('no-animation');
            target.classList.remove('no-map');
            target.classList.remove('capture-no-border');
            btn.innerText = originalBtnText; btn.disabled = false;
        });
    }, htmlDelay); 
}

function copyTextData(idx, btnEl) {
    const copyTarget = document.getElementById(`copy-text-area-${idx}`);
    copyTarget.select();
    copyTarget.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyTarget.value).then(() => {
        const originalText = btnEl.innerText;
        btnEl.innerText = "âœ… å¤åˆ¶æˆåŠŸ";
        btnEl.style.background = "var(--success)";
        setTimeout(() => {
            btnEl.innerText = originalText;
            btnEl.style.background = ""; 
        }, 2000);
    });
}

function updateDistCrz(idx, field, val) {
    // å·¡èˆªé«˜åº¦ä¸èˆªç¨‹åšè¾“å…¥è§„èŒƒåŒ–ï¼Œä¿è¯ä½æ•°ä¸æ ¼å¼
    if (field === 'crz') {
        // åªä¿ç•™æ•°å­—ï¼Œé™åˆ¶ä¸ºæœ€å¤š 3 ä½
        let digits = (val || '').toString().replace(/\D/g, '');
        if (digits.length > 3) digits = digits.slice(0, 3);
        flightData[idx][field] = digits;
    } else if (field === 'dist') {
        // è·ç¦»åªä¿ç•™æ•°å­—
        let digits = (val || '').toString().replace(/[^\d]/g, '');
        flightData[idx][field] = digits;
    } else {
        flightData[idx][field] = val;
    }
    let leg = flightData[idx];
    let rowEl = document.getElementById(`disp-metrics-divider-${idx}`);
    let arcEl = document.getElementById(`disp-crz-arc-${idx}`);
    let distSpan = document.getElementById(`disp-dist-val-${idx}`);
    let crzText = document.getElementById(`disp-crz-text-${idx}`);
    
    // âœ¨ æ ¸å¿ƒè°ƒæ•´ï¼šç¡®ä¿æ˜¾ç¤ºä¸º 3 ä½æ•°å­—çš„ FL æ ¼å¼
    let cleanCrz = leg.crz ? leg.crz.toString().replace(/^FL\s*/i, '').trim() : '';
    if (cleanCrz.length > 3) cleanCrz = cleanCrz.substring(0, 3);
    
    // æ›´æ–°è·ç¦»æ˜¾ç¤º
    if (leg.dist) {
        if (rowEl) rowEl.style.display = 'flex';
        if (distSpan) distSpan.innerText = leg.dist + ' NM';
    } else {
        if (rowEl) rowEl.style.display = 'none';
    }

    // æ›´æ–°å·¡èˆªé«˜åº¦å¼§çº¿æ˜¾ç¤ºï¼ˆæ— ç©ºæ ¼ï¼Œå¦‚ FL361ï¼‰
    if (cleanCrz) {
        if (arcEl) arcEl.style.display = 'flex';
        if (crzText) crzText.innerText = 'FL' + cleanCrz;
    } else {
        if (arcEl) arcEl.style.display = 'none';
    }
}

function autoInput(idx, field, el) {
    const code = el.value.toUpperCase(); 
    flightData[idx][field] = code;
    
    let dispEl = document.getElementById(`disp-${field}-${idx}`);
    if(dispEl) dispEl.innerText = code;

    const nameField = field + 'N';
    const airportName = (typeof DB !== 'undefined' && DB[code]) ? DB[code] : '';
    flightData[idx][nameField] = airportName;

    const targetInput = document.getElementById(`${nameField}-${idx}`);
    if (targetInput) targetInput.value = airportName;

    let dispNameEl = document.getElementById(`disp-${nameField}-${idx}`);
    if(dispNameEl) dispNameEl.innerText = airportName;

    updateCopyText(idx);

    if ((field === 'dep' || field === 'arr') && flightData[idx].dep.length === 4 && flightData[idx].arr.length === 4) {
        initMapForLeg(idx);
    }
    if (field === 'alt' && flightData[idx].dep.length === 4 && flightData[idx].arr.length === 4) {
        initMapForLeg(idx);
    }
}

function updateData(idx, field, val) { 
    flightData[idx][field] = val; 
    let dispEl = document.getElementById(`disp-${field}-${idx}`);
    if(dispEl) dispEl.innerText = val;
    if (field === 'rte' || field === 'dep' || field === 'depRwy' || field === 'arr' || field === 'arrRwy') {
        let leg = flightData[idx];
        let fullRoute = [leg.dep + (leg.depRwy ? '/' + leg.depRwy : ''), leg.rte, leg.arr + (leg.arrRwy ? '/' + leg.arrRwy : '')].filter(Boolean).join(' ').trim();
        let rteDisp = document.getElementById(`disp-rte-${idx}`);
        if (rteDisp) rteDisp.innerText = fullRoute;
    }
    updateCopyText(idx);
}

function addNewLeg() {
    const lastLeg = flightData[flightData.length - 1];
    flightData.push({ call: lastLeg.call, acft: lastLeg.acft, dist: '', crz: '', dep: lastLeg.arr, depN: lastLeg.arrN, depRwy: '', sid: '', depTrans: '', arr: '', arrN: '', arrTrans: '', star: '', arrRwy: '', alt: '', altN: '', rte: '', imgs: [], depWx: '', arrWx: '' });
    renderEditor(); 
    draw();
}

function deleteLeg(idx) {
    if (flightData.length > 1) { flightData.splice(idx, 1); renderEditor(); draw(); }
}

function handleFiles(e, idx) {
    Array.from(e.target.files).forEach(f => {
        let r = new FileReader(); r.onload = (ev) => { flightData[idx].imgs.push(ev.target.result); renderEditor(); draw(); }; r.readAsDataURL(f);
    });
}

function deleteImg(legIdx, imgIdx) { flightData[legIdx].imgs.splice(imgIdx, 1); renderEditor(); draw(); }

function renderEditor() {
    const stack = document.getElementById('editorStack'); 
    stack.innerHTML = '';
    
    flightData.forEach((leg, i) => {
        const div = document.createElement('div'); 
        div.className = 'leg-block';
        div.id = `editor-leg-${i}`;
        
        let imgsHtml = (leg.imgs || []).map((img, imgIdx) => `
            <div class="img-thumb-wrapper">
                <img src="${img}" class="img-thumb">
                <button class="del-img-btn" onclick="deleteImg(${i}, ${imgIdx})">Ã—</button>
            </div>
        `).join('');
        
        let deleteBtnHtml = flightData.length > 1 ? `
            <button onclick="deleteLeg(${i})" style="background:none; border:none; color:var(--warn); cursor:pointer; font-weight:800; font-size:12px; padding:0;">[åˆ é™¤è¯¥æ®µ]</button>
        ` : '';
        
        let wxButtonsHtml = `
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div style="display:flex; gap:5px;">
                    <button onclick="fetchMetar(${i}, 'dep')" style="flex:1; background:var(--accent); color:#fff; border:none; border-radius:6px; font-size:11px; padding:8px; cursor:pointer;">èµ·é£å¤©æ°”</button>
                    <button onclick="deleteWx(${i}, 'dep')" style="background:var(--warn); color:#fff; border:none; border-radius:6px; font-size:11px; width:35px; cursor:pointer;">æ’¤</button>
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="fetchMetar(${i}, 'arr')" style="flex:1; background:var(--accent); color:#fff; border:none; border-radius:6px; font-size:11px; padding:8px; cursor:pointer;">åˆ°è¾¾å¤©æ°”</button>
                    <button onclick="deleteWx(${i}, 'arr')" style="background:var(--warn); color:#fff; border:none; border-radius:6px; font-size:11px; width:35px; cursor:pointer;">æ’¤</button>
                </div>
            </div>
        `;
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span style="font-size:14px; font-weight:900; color:var(--text);">âœˆï¸ èˆªæ®µ ${i + 1}</span>
                ${deleteBtnHtml}
            </div>
            
            <div class="editor-group">
                <div class="editor-group-title">åŸºç¡€ä¿¡æ¯</div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1.2;">
                        <label>èˆªç­å·</label>
                        <input type="text" value="${leg.call}" oninput="updateData(${i}, 'call', this.value)">
                    </div>
                    <div style="flex:1.5;">
                        <label>æœºå‹</label>
                        <input type="text" list="acft-list" value="${leg.acft}" oninput="updateData(${i}, 'acft', this.value)">
                    </div>
                </div>
            </div>
            
            <div class="editor-group">
                <div class="editor-group-title">èˆªç«™ä¸èˆªç¨‹</div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>èµ·é£ ICAO</label>
                        <input type="text" value="${leg.dep}" maxlength="4" oninput="autoInput(${i}, 'dep', this)">
                    </div>
                    <div style="flex:1;">
                        <label>åˆ°è¾¾ ICAO</label>
                        <input type="text" value="${leg.arr}" maxlength="4" oninput="autoInput(${i}, 'arr', this)">
                    </div>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:8px;">
                    <input type="text" id="depN-${i}" value="${leg.depN}" oninput="updateData(${i}, 'depN', this.value)">
                    <input type="text" id="arrN-${i}" value="${leg.arrN}" oninput="updateData(${i}, 'arrN', this.value)">
                </div>
                
                <div style="display:flex; gap:10px; margin-top:8px;">
                    <div style="flex:1;">
                        <label>èˆªç¨‹ (NM)</label>
                        <input type="text" value="${leg.dist || ''}" oninput="updateDistCrz(${i}, 'dist', this.value)">
                    </div>
                    <div style="flex:1;">
                        <label>å·¡èˆªé«˜åº¦ (FL)</label>
                        <input type="text" value="${leg.crz || ''}" oninput="updateDistCrz(${i}, 'crz', this.value)">
                    </div>
                </div>
            </div>
            
            <div class="editor-group">
                <div class="editor-group-title">èˆªè·¯ä¸ç¨‹åº</div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>ç¦»åœºè·‘é“</label>
                        <input type="text" value="${leg.depRwy}" oninput="updateData(${i}, 'depRwy', this.value)">
                    </div>
                    <div style="flex:1.5;">
                        <label>ç¦»åœºç¨‹åº</label>
                        <input type="text" value="${leg.sid}" oninput="updateData(${i}, 'sid', this.value)">
                    </div>
                    <div style="flex:1;">
                        <label>ç¦»åœºè¿‡æ¸¡</label>
                        <input type="text" value="${leg.depTrans}" oninput="updateData(${i}, 'depTrans', this.value)">
                    </div>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:8px;">
                    <div style="flex:1;">
                        <label>è¿›åœºè·‘é“</label>
                        <input type="text" value="${leg.arrRwy}" oninput="updateData(${i}, 'arrRwy', this.value)">
                    </div>
                    <div style="flex:1.5;">
                        <label>è¿›åœºç¨‹åº</label>
                        <input type="text" value="${leg.star}" oninput="updateData(${i}, 'star', this.value)">
                    </div>
                    <div style="flex:1;">
                        <label>è¿›åœºè¿‡æ¸¡</label>
                        <input type="text" value="${leg.arrTrans}" oninput="updateData(${i}, 'arrTrans', this.value)">
                    </div>
                </div>
                
                <label style="margin-top:12px;">å¤‡é™åœº (ALTN)</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" value="${leg.alt}" maxlength="4" oninput="autoInput(${i}, 'alt', this)" style="flex:1;">
                    <input type="text" id="altN-${i}" value="${leg.altN}" oninput="updateData(${i}, 'altN', this.value)" style="flex:2;">
                </div>
                
                <label style="margin-top:12px;">èˆªè·¯ä¿¡æ¯ (ROUTE)</label>
                <textarea rows="3" oninput="updateData(${i}, 'rte', this.value)">${leg.rte}</textarea>
            </div>
            
            <div class="editor-group">
                <div class="editor-group-title">æ°”è±¡ä¸é™„ä»¶</div>
                ${wxButtonsHtml}
                
                <label style="margin-top:15px;">æ·»åŠ å‚è€ƒå›¾</label>
                <input type="file" multiple accept="image/*" onchange="handleFiles(event, ${i})">
                <div class="img-manage-list">${imgsHtml}</div>
            </div>
        `;
        stack.appendChild(div);
    });
}

function initMapForLeg(idx) {
    const depICAO = flightData[idx].dep; const arrICAO = flightData[idx].arr;
    const container = document.getElementById(`map-placeholder-${idx}`);
    if (!container) return;
    let depP, arrP, altP;
    if (typeof COORDS_DB !== 'undefined' && COORDS_DB[depICAO]) { depP = { lat: COORDS_DB[depICAO][0], lon: COORDS_DB[depICAO][1] }; } else if (airportGeoData[depICAO]) { depP = { lat: airportGeoData[depICAO].lat, lon: airportGeoData[depICAO].lon }; }
    if (typeof COORDS_DB !== 'undefined' && COORDS_DB[arrICAO]) { arrP = { lat: COORDS_DB[arrICAO][0], lon: COORDS_DB[arrICAO][1] }; } else if (airportGeoData[arrICAO]) { arrP = { lat: airportGeoData[arrICAO].lat, lon: airportGeoData[arrICAO].lon }; }
    const altICAO = flightData[idx].alt;
    if (altICAO) {
        if (typeof COORDS_DB !== 'undefined' && COORDS_DB[altICAO]) { altP = { lat: COORDS_DB[altICAO][0], lon: COORDS_DB[altICAO][1] }; } 
        else if (airportGeoData[altICAO]) { altP = { lat: airportGeoData[altICAO].lat, lon: airportGeoData[altICAO].lon }; }
    }
    
    if (!depP || !arrP) {
        container.innerHTML = "";
        if (mapInstances[idx]) { mapInstances[idx].remove(); mapInstances[idx] = null; }
        mapDoms[idx] = null;
        overlayGroups[idx] = null;
        routeLayers[idx] = null;
        altLayers[idx] = null;
        altMarkers[idx] = null;
        lastLegICAO[idx] = null;
        return;
    }
    
    const currentKey = `${depICAO}-${arrICAO}-${altICAO || ''}`;
    if (lastLegICAO[idx] === currentKey && mapDoms[idx]) { 
        container.appendChild(mapDoms[idx]); 
        if (mapInstances[idx]) {
             mapInstances[idx].invalidateSize();
             const rl = routeLayers[idx];
             if (rl) {
                 let b = rl.getBounds();
                 if (altLayers[idx]) b = b.extend(altLayers[idx].getBounds());
                 mapInstances[idx].fitBounds(b, { padding: [80, 80], animate: false });
             }
        }
        return; 
    }

    // ä»…å¤‡é™å˜åŒ–æ—¶åŸåœ°æ›´æ–°ï¼Œé¿å…æ•´å›¾é‡å»ºé—ªçƒ
    const prevKey = lastLegICAO[idx] || '';
    const parts = prevKey.split('-');
    const lastDep = parts[0] || '';
    const lastArr = parts[1] || '';
    if (mapInstances[idx] && depICAO === lastDep && arrICAO === lastArr) {
        if (mapDoms[idx] && mapDoms[idx].parentNode !== container) container.appendChild(mapDoms[idx]);
        const map = mapInstances[idx];
        if (altLayers[idx]) { map.removeLayer(altLayers[idx]); altLayers[idx] = null; }
        if (altMarkers[idx]) { map.removeLayer(altMarkers[idx]); altMarkers[idx] = null; }
        if (altP) {
            const altStart = [arrP.lat, arrP.lon];
            const altEnd = [altP.lat, altP.lon];
            const aox = altEnd[1] - altStart[1];
            const aoy = altEnd[0] - altStart[0];
            const ar = Math.sqrt(aox * aox + aoy * aoy);
            const atheta = Math.atan2(aoy, aox);
            const altControl = [ altStart[0] + (ar / 2) * Math.sin(atheta + 0.3), altStart[1] + (ar / 2) * Math.cos(atheta + 0.3) ];
            const altCurvePoints = [];
            for (let t = 0; t <= 1.001; t += 0.01) {
                const x = (1 - t) * (1 - t) * altStart[0] + 2 * (1 - t) * t * altControl[0] + t * t * altEnd[0];
                const y = (1 - t) * (1 - t) * altStart[1] + 2 * (1 - t) * t * altControl[1] + t * t * altEnd[1];
                altCurvePoints.push([x, y]);
            }
            altLayers[idx] = L.polyline(altCurvePoints, { color: '#dc2626', weight: 1.5, dashArray: '4, 8', opacity: 0.75 }).addTo(map);
            altMarkers[idx] = L.circleMarker([altP.lat, altP.lon], { radius: 5, color: '#dc2626', fillColor: '#dc2626', fillOpacity: 1 }).addTo(map);
            let b = routeLayers[idx].getBounds();
            b = b.extend(altLayers[idx].getBounds());
            map.fitBounds(b, { padding: [80, 80], animate: false });
        }
        lastLegICAO[idx] = currentKey;
        return;
    }

    // èµ·é™å˜åŒ–æ—¶ä¹ŸåŸåœ°æ›´æ–°ï¼šåªæ¸…ç©ºå åŠ å±‚é‡ç»˜ï¼Œä¸é”€æ¯åœ°å›¾ï¼ˆä¸å¤‡é™é€»è¾‘ä¸€è‡´ï¼Œé¿å…é—ªçƒï¼‰
    function arrowDataUrl(angleDeg) {
        const svg = '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><g transform="rotate(' + angleDeg + ' 6 6)"><path d="M6 1 L10 11 L6 9 L2 11 Z" fill="#7c3aed" stroke="rgba(255,255,255,0.6)" stroke-width="0.5"/></g></svg>';
        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }
    function addOverlayLayers(group, dP, aP, alP, legIdx) {
        const pts = [[dP.lat, dP.lon], [aP.lat, aP.lon]];
        L.circleMarker(pts[0], { radius: 5, color: '#db2777', fillColor: '#db2777', fillOpacity: 1 }).addTo(group);
        L.circleMarker(pts[1], { radius: 5, color: '#059669', fillColor: '#059669', fillOpacity: 1 }).addTo(group);
        const offsetX = pts[1][1] - pts[0][1];
        const offsetY = pts[1][0] - pts[0][0];
        const r = Math.sqrt(offsetX * offsetX + offsetY * offsetY);
        const theta = Math.atan2(offsetY, offsetX);
        const controlPoint = [ pts[0][0] + (r/2) * Math.sin(theta + 0.3), pts[0][1] + (r/2) * Math.cos(theta + 0.3) ];
        const curvePoints = [];
        for (let t = 0; t <= 1.001; t += 0.01) {
            curvePoints.push([
                (1-t)*(1-t)*pts[0][0] + 2*(1-t)*t*controlPoint[0] + t*t*pts[1][0],
                (1-t)*(1-t)*pts[0][1] + 2*(1-t)*t*controlPoint[1] + t*t*pts[1][1]
            ]);
        }
        const polyline = L.polyline(curvePoints, { color: '#7c3aed', weight: 1.5, dashArray: '4, 8', opacity: 0.75 }).addTo(group);
        const numArrows = Math.min(8, Math.max(5, Math.floor(curvePoints.length / 12)));
        for (let a = 1; a <= numArrows; a++) {
            const t = a / (numArrows + 1);
            const arrowIndex = Math.floor(t * (curvePoints.length - 1));
            const arrowLatLng = curvePoints[arrowIndex];
            const i0 = Math.max(0, arrowIndex - 4);
            const i1 = Math.min(curvePoints.length - 1, arrowIndex + 4);
            const dx = curvePoints[i1][1] - curvePoints[i0][1];
            const dy = curvePoints[i1][0] - curvePoints[i0][0];
            const angleDeg = Math.atan2(dx, dy) * 180 / Math.PI;
            const arrowIcon = L.icon({ iconUrl: arrowDataUrl(angleDeg), iconSize: [12, 12], iconAnchor: [6, 6], className: 'route-arrow-icon' });
            L.marker(arrowLatLng, { icon: arrowIcon, interactive: false }).addTo(group);
        }
        let altLine = null;
        let altMarker = null;
        if (alP) {
            const altStart = [aP.lat, aP.lon];
            const altEnd = [alP.lat, alP.lon];
            const aox = altEnd[1] - altStart[1];
            const aoy = altEnd[0] - altStart[0];
            const ar = Math.sqrt(aox * aox + aoy * aoy);
            const atheta = Math.atan2(aoy, aox);
            const altControl = [ altStart[0] + (ar / 2) * Math.sin(atheta + 0.3), altStart[1] + (ar / 2) * Math.cos(atheta + 0.3) ];
            const altCurvePoints = [];
            for (let t = 0; t <= 1.001; t += 0.01) {
                altCurvePoints.push([
                    (1 - t) * (1 - t) * altStart[0] + 2 * (1 - t) * t * altControl[0] + t * t * altEnd[0],
                    (1 - t) * (1 - t) * altStart[1] + 2 * (1 - t) * t * altControl[1] + t * t * altEnd[1]
                ]);
            }
            altLine = L.polyline(altCurvePoints, { color: '#dc2626', weight: 1.5, dashArray: '4, 8', opacity: 0.75 }).addTo(group);
            altMarker = L.circleMarker([alP.lat, alP.lon], { radius: 5, color: '#dc2626', fillColor: '#dc2626', fillOpacity: 1 }).addTo(group);
        }
        return { polyline: polyline, altLine: altLine, altMarker: altMarker };
    }

    if (mapInstances[idx] && overlayGroups[idx]) {
        if (mapDoms[idx] && mapDoms[idx].parentNode !== container) container.appendChild(mapDoms[idx]);
        const map = mapInstances[idx];
        const group = overlayGroups[idx];
        group.clearLayers();
        const result = addOverlayLayers(group, depP, arrP, altP, idx);
        routeLayers[idx] = result.polyline;
        altLayers[idx] = result.altLine;
        altMarkers[idx] = result.altMarker;
        lastLegICAO[idx] = currentKey;
        let bounds = result.polyline.getBounds();
        if (result.altLine) bounds = bounds.extend(result.altLine.getBounds());
        map.fitBounds(bounds, { padding: [80, 80], animate: false });
        return;
    }

    const mapDiv = document.createElement('div');
    mapDiv.className = 'map-container';
    container.appendChild(mapDiv);
    mapDoms[idx] = mapDiv;

    const map = L.map(mapDiv, { zoomControl: false, attributionControl: false, fadeAnimation: false, zoomAnimation: false, preferCanvas: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { subdomains: 'abc', maxZoom: 19, crossOrigin: true }).addTo(map);
    const overlayGroup = L.layerGroup().addTo(map);
    overlayGroups[idx] = overlayGroup;

    const result = addOverlayLayers(overlayGroup, depP, arrP, altP, idx);
    routeLayers[idx] = result.polyline;
    altLayers[idx] = result.altLine;
    altMarkers[idx] = result.altMarker;
    lastLegICAO[idx] = currentKey;

    let bounds = result.polyline.getBounds();
    if (result.altLine) bounds = bounds.extend(result.altLine.getBounds());
    map.fitBounds(bounds, { padding: [80, 80], animate: false });

    mapInstances[idx] = map;
    setTimeout(() => { map.invalidateSize(); }, 50);
}

function updatePlaneLineBounds() {
    const gap = 14;
    flightData.forEach((_, i) => {
        const card = document.getElementById('card-leg-' + i);
        if (!card) return;
        const header = card.querySelector('.header');
        const leftStation = card.querySelector('.header .station.align-left');
        const rightStation = card.querySelector('.header .station.align-right');
        const wrap = card.querySelector('.plane-lines-wrap');
        if (!header || !leftStation || !rightStation || !wrap) return;
        const leftEnd = leftStation.offsetLeft + leftStation.offsetWidth + gap;
        const rightStart = rightStation.offsetLeft - gap;
        wrap.style.setProperty('--line-left-start', leftEnd + 'px');
        wrap.style.setProperty('--line-right-end', (header.offsetWidth - rightStart) + 'px');
    });
}

function draw() {
    const zone = document.getElementById('previewZone'); 
    const copyZone = document.getElementById('copy-zone');
    const vault = document.getElementById('permanent-vault');
    flightData.forEach((_, i) => { if (mapDoms[i]) vault.appendChild(mapDoms[i]); });
    zone.innerHTML = '';
    copyZone.innerHTML = '';

    flightData.forEach((leg, i) => {
        let imgs = (leg.imgs || []).map(s => `<img src="${s}">`).join('');
        let galleryHtml = imgs ? `<div class="gallery">${imgs}</div>` : '';
        let dWx = leg.depWx ? `<div class="weather-box"><span class="weather-label">DEPARTURE METAR (${leg.dep})</span><div class="weather-code">${leg.depWx}</div></div>` : '';
        let aWx = leg.arrWx ? `<div class="weather-box"><span class="weather-label">ARRIVAL METAR (${leg.arr})</span><div class="weather-code">${leg.arrWx}</div></div>` : '';
        
        let cleanCrz = leg.crz ? leg.crz.replace(/^FL\s*/i, '').trim() : '';
        const hasMultiLegs = flightData.length > 1;
        const legNoLabel = hasMultiLegs ? ` ${i + 1}` : '';

        // âœ¨ æ ¸å¿ƒè°ƒæ•´ï¼šè·ç¦»æ å®Œç¾å‚ç›´å¯¹é½
        let distHtml = leg.dist ? `
        <div class="metrics-divider" id="disp-metrics-divider-${i}">
            <div class="m-line"></div>
            <div class="m-data-area">
                <span class="m-label-sub">DIST</span>
                <span class="m-val-sub val-dist" id="disp-dist-val-${i}">${leg.dist} NM</span>
            </div>
            <div class="m-line"></div>
        </div>` : 
        `<div class="metrics-divider" id="disp-metrics-divider-${i}" style="display:none;">
            <div class="m-line"></div>
            <div class="m-data-area">
                <span class="m-label-sub">DIST</span>
                <span class="m-val-sub val-dist" id="disp-dist-val-${i}"></span>
            </div>
            <div class="m-line"></div>
        </div>`;

        let arcHtml = `
        <div class="crz-arc-container" id="disp-crz-arc-${i}" style="display: ${cleanCrz ? 'flex' : 'none'}">
             <svg class="crz-arc-svg" viewBox="0 0 400 55" preserveAspectRatio="none">
                 <path d="M 60 45 Q 200 8 340 45" /> </svg>
             <div class="crz-arc-text" id="disp-crz-text-${i}">FL${cleanCrz}</div>
        </div>`;

        let fullRouteDisplay = [leg.dep + (leg.depRwy ? '/' + leg.depRwy : ''), leg.rte, leg.arr + (leg.arrRwy ? '/' + leg.arrRwy : '')].filter(Boolean).join(' ').trim();
        zone.innerHTML += `
        <div class="card" id="card-leg-${i}">
            ${arcHtml}
            <div class="header">
                <div class="plane-lines-wrap"><div class="plane-line-left"></div><div class="plane-line-right"></div></div>
                <div class="station align-left"><span class="m-title">DEPARTURE</span><div class="icao" id="disp-dep-${i}">${leg.dep || ''}</div><div class="cn-name" id="disp-depN-${i}">${leg.depN || ''}</div></div>
                <div class="route-visual"></div>
                <div class="plane-center-fixed">
                    <div class="plane-box"><svg viewBox="0 0 24 24"><path transform="rotate(90 12 12)" d="M21,16L21,14L13,9L13,3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5L10,9L2,14L2,16L10,13.5L10,19L8,20.5L8,22L11.5,21L15,22L15,20.5L13,19L13,13.5L21,16Z"/></svg></div>
                    <div class="callsign-text" id="disp-call-${i}">${leg.call || ''}</div>
                </div>
                <div class="station align-right"><span class="m-title">ARRIVAL</span><div class="icao" id="disp-arr-${i}">${leg.arr || ''}</div><div class="cn-name" id="disp-arrN-${i}">${leg.arrN || ''}</div></div>
            </div>
            
            ${distHtml}             <div class="meta-grid">
                <div class="meta-item align-left"><span class="m-title meta-acft">AIRCRAFT</span><div class="m-val" id="disp-acft-${i}">${leg.acft || ''}</div></div>
                <div class="meta-item align-center"><span class="m-title meta-altn">ALTERNATE</span><div class="m-val" style="color:var(--warn)" id="disp-alt-${i}">${leg.alt || ''}</div></div>
                <div class="meta-item align-center"><span class="m-title">STATUS</span><div class="m-val" style="color:#22c55e">RELEASED</div></div>
                <div class="meta-item align-right"><span class="m-title meta-utc">UTC TIME</span><div class="m-val">${new Date().getUTCHours().toString().padStart(2,'0')}:${new Date().getUTCMinutes().toString().padStart(2,'0')}Z</div></div>
            </div>

            <div class="route-zone">
                <div class="proc-grid">
                    <div class="proc-box"><div class="proc-label">DEP RWY</div><div class="proc-val rwy-val" id="disp-depRwy-${i}">${leg.depRwy || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">SID</div><div class="proc-val" style="color: #db2777;" id="disp-sid-${i}">${leg.sid || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">TRANS</div><div class="proc-val" style="color: #9333ea;" id="disp-depTrans-${i}">${leg.depTrans || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">STAR</div><div class="proc-val" style="color: #059669;" id="disp-star-${i}">${leg.star || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">TRANS</div><div class="proc-val" style="color: #ea580c;" id="disp-arrTrans-${i}">${leg.arrTrans || ''}</div></div>
                    <div class="proc-box"><div class="proc-label">ARR RWY</div><div class="proc-val rwy-val" id="disp-arrRwy-${i}">${leg.arrRwy || ''}</div></div>
                </div>
                <div class="route-title">ENROUTE BRIEFING${legNoLabel}</div><div class="route-text" id="disp-rte-${i}">${fullRouteDisplay}</div>
                <div id="disp-depWx-container-${i}">${dWx}</div>
                <div id="disp-arrWx-container-${i}">${aWx}</div>
            </div>
            <div id="map-placeholder-${i}" class="map-wrapper"></div>
            ${galleryHtml}
        </div>`;

        copyZone.innerHTML += `
            <div class="copy-section">
                <h3>ENROUTE BRIEFING${hasMultiLegs ? ' ' + (i + 1) : ''}
                    <button class="copy-btn" onclick="copyTextData(${i}, this)">ä¸€é”®å¤åˆ¶</button>
                </h3>
                <textarea class="copy-textarea" id="copy-text-area-${i}" readonly>${fullRouteDisplay}</textarea>
            </div>`;

        requestAnimationFrame(() => initMapForLeg(i));
    });
    requestAnimationFrame(() => { updatePlaneLineBounds(); });
}

if (typeof window !== 'undefined') {
    window.addEventListener('resize', function() { updatePlaneLineBounds(); });
}
</script>
</body>
</html>